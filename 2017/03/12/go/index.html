<!DOCTYPE html>
<html lang=en>
<head>
	<!-- hexo-inject:begin --><!-- hexo-inject:end --><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css">
	<link rel="stylesheet" type="text/css" href="css/comment.css">    
    <meta charset="utf-8">
    
    <title>Go初探 | Tankcat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    

    

    
        <link rel="shortcut icon" href="/css/images/favicon.ico" />
    
	
    <link rel="stylesheet" href="/vendor/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/vendor/open-sans/styles.css">
    <link rel="stylesheet" href="/vendor/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/tagclouds.css">
	<link rel="stylesheet" href="/css/font-awesome.css">
    <script src="/vendor/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/vendor/lightgallery/css/lightgallery.min.css">
    
    
    
    
    


	<script src="//cdn.bootcss.com/jquery/2.1.0/jquery.min.js" type="text/javascript"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
        
    <header id="header">
    <div id="header-main" class="header-inner">
			 <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/index.html">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archive</a>
                
                    <a class="main-nav-link" href="/categories">Category</a>
                
                    <a class="main-nav-link" href="/tags">Tag</a>
                
                    <a class="main-nav-link" href="/about">About</a>
                
                    <a class="main-nav-link" href="/favorite">Photos</a>
                
            </nav>
            
    </div> 
	</div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/index.html">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archive</a></td>
                
                    <td><a class="main-nav-link" href="/categories">Category</a></td>
                
                    <td><a class="main-nav-link" href="/tags">Tag</a></td>
                
                    <td><a class="main-nav-link" href="/about">About</a></td>
                
                    <td><a class="main-nav-link" href="/favorite">Photos</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>




			
        <div class="outer">
			<aside id="profile">
					<div class="profile-inner">
					</div>
			</aside>
			
					<section id="main"><article id="post-go" class="article article-type-post" itemscope itemprop="blogPost">
    
	<div class="article-inner" style="border-radius:1.5px; box-shadow: 10px 10px 5px #ccc;">
        
            
	
		<img src="http://7xwggp.com1.z0.glb.clouddn.com/project.png" class="article-banner" />
	



        
        
            <header class="article-header">
				
					<center>
    
        <h1 class="article-title" itemprop="name">
            Go初探
        </h1>
    

					 
						<div class="article-meta">
							
    <div class="article-date">    
        <a href="/2017/03/12/go/">
            <time datetime="2017-03-12T13:31:31.000Z" itemprop="datePublished">2017-03-12</time>
        </a>
    </div>

							<!--
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Go/">Go</a>
		&nbsp;&nbsp;
		
			<span class="article-tag">
				<i class="fa fa-tag"></i>
				<a class="tag-link" href="/tags/Go/">Go</a>, <a class="tag-link" href="/tags/MIT6-824/">MIT6.824</a>
			</span>
		
    </div>
-->
							<!--
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Go/">Go</a>, <a class="tag-link" href="/tags/MIT6-824/">MIT6.824</a>
    </div>
-->
						</div>
					
					
					
						<span class="article-meta">
							
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Go/">Go</a>
		&nbsp;&nbsp;
		
			<span class="article-tag">
				<i class="fa fa-tag"></i>
				<a class="tag-link" href="/tags/Go/">Go</a>, <a class="tag-link" href="/tags/MIT6-824/">MIT6.824</a>
			</span>
		
    </div>

							
						</span>
						
					
					
					</center>
				
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
			
				<br/>
				 <blockquote style="font-size:120%;line-height:1.5em;color:#083a4e">
					最近在自学MIT6.824的分布式系统课程，实验部分使用的语言是Go，所以根据Go指南，手动实现了所有的教程。
				 </blockquote>
			  
            <h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><h3 id="包，变量和函数"><a href="#包，变量和函数" class="headerlink" title="包，变量和函数"></a>包，变量和函数</h3><ol>
<li><p>每个Go程序都是由<code>包</code>组成的，程序运行的入口是<code>main</code>。下面的程序使用并导入了包<code>fmt</code>和<code>math/rand</code>。一般地，包名与导入路径的最后一个目录一致，即<code>math/rand</code>包由<code>package rand</code>语句开始。</p>
<a id="more"></a>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">  	<span class="string">"math/rand"</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  fmt.Println(<span class="string">"My favorite number is"</span>, rand.Int(<span class="number">10</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">My favorite number is <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>上述的导入语句是使用了圆括号进行组合导入，即<code>打包</code>导入。也可以编写成多个导入语句，即：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"math/rand"</span></span><br></pre></td></tr></table></figure>
<p>在Go中，首字母大写的名称是被导出的，比如<code>Pi</code>是从包<code>math</code>中导出的名称 。在导入包之后，你只能访问包所导出的名称，任何包未导出的名称均不能被包外的代码访问。执行下面的代码会出错，需要将<code>math.pi</code>替换成<code>math.Pi</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span>(</span><br><span class="line">  	<span class="string">"fmt"</span></span><br><span class="line">  	<span class="string">"math"</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span></span>&#123;</span><br><span class="line">  	fmt.Println(math.pi)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">tmp/sandbox738653879/main.<span class="keyword">go</span>:<span class="number">9</span>: cannot refer to unexported name math.pi</span><br><span class="line">tmp/sandbox738653879/main.<span class="keyword">go</span>:<span class="number">9</span>: undefined: math.pi</span><br></pre></td></tr></table></figure>
</li>
<li><p>在Go中，函数可以没有参数，或者接受多个参数，在下面的例子中，<code>add</code>接受两个<code>int</code>类型的参数。需要注意的是，类型位于变量名之后。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(x <span class="keyword">int</span>, y <span class="keyword">int</span>)</span><span class="title">int</span></span>&#123;</span><br><span class="line">  	<span class="keyword">return</span> x+y</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  	fmt.Println(add(<span class="number">1</span>,<span class="number">2</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>当函数的两个或者连续多个参数是同一类型时，可以省略除了最后一个参数的其他参数的类型，比如<code>add</code>函数的参数可以重新写成<code>x, y int</code>。</p>
<p>此外，函数的返回值数量可以是任意多个，比如下面的例子<code>swap</code>函数返回了两个字符串。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">swap</span><span class="params">(x, y <span class="keyword">string</span>)</span><span class="params">(<span class="keyword">string</span>,<span class="keyword">string</span>)</span></span>&#123;</span><br><span class="line">  	<span class="keyword">return</span> y,x</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  a, b　:= swap(<span class="string">"hello"</span>,<span class="string">"world"</span>)</span><br><span class="line">  fmt.Println(a,b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">world hello</span><br></pre></td></tr></table></figure>
<p>Go的返回值可以被命名，并可像在函数体开头声明的变量那样使用。下面的例子中，返回值是两个int类型的变量x和y，函数内的<code>return</code>语句没有参数，返回各个变量的当前值，称为<code>裸返回</code>。裸返回语句只能用在类似下面例子中的短函数中，在长函数中使用会影响代码的可读性。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">split</span><span class="params">(sum <span class="keyword">int</span>)</span><span class="params">(x, y <span class="keyword">int</span>)</span></span>&#123;</span><br><span class="line">  	x = sum * <span class="number">4</span> / <span class="number">9</span></span><br><span class="line">  	y = sum - x</span><br><span class="line">  	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  	fmt.Println(split(<span class="number">17</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line"><span class="number">7</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>关键字<code>var</code>用于定义变量，与函数的参数列表一样，类型放在变量名后面。下面的例子中定义了一个变量列表，<code>var</code>语句可以在包或者函数级别中使用。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="keyword">var</span> c, clojure, java <span class="keyword">int</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  	<span class="keyword">var</span> flag <span class="keyword">bool</span></span><br><span class="line">  	fmt.Println(flag, c, clojure, java)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line"><span class="literal">false</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>变量定义如果不包含初始值，则对应默认值，比如<code>int</code>的默认值为0，<code>bool</code>的默认值为false，<code>string</code>的默认值为””。</p>
<p>当变量定义包含初始值时，一个变量对应一个值。如果初始化使用的是表达式，则变量可以省略类型，从初始值中获得类型。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="keyword">var</span> flag, label <span class="keyword">bool</span> = <span class="literal">true</span>, <span class="literal">false</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  	<span class="keyword">var</span> c, clojure, java = <span class="number">1</span>, <span class="string">"great"</span>, <span class="number">2.1</span></span><br><span class="line">  	fmt.Println(flag, label, c, clojure, java)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line"><span class="literal">true</span> <span class="literal">false</span> <span class="number">1</span> great <span class="number">2.1</span></span><br></pre></td></tr></table></figure>
<p>回顾<code>swap</code>例子中的main函数使用的操作符<code>:=</code>，对应地，a和b为<code>短声明变量</code>，该操作符可以在类型明确的地方替代<code>var</code>。<strong>需要注意的是，:=不能在函数外使用，函数外的每个语句都必须以关键字开始(<code>var</code>, <code>func</code>等)</strong>。</p>
</li>
<li><p>Go的基本类型如下：</p>
<ul>
<li>bool</li>
<li>string</li>
<li>int int8 int16 int32 int64 </li>
<li>uint uint8 uint16 uint32 uint64 uinttr</li>
<li>byte // unit8的别名</li>
<li>rune // int32的别名，代表一个Unicode码</li>
<li>float32 float64</li>
<li>complex64 complex128</li>
</ul>
<p><code>int</code>，<code>uint</code>和<code>uintptr</code>类型在32位的系统上一般是32位，在64位系统上是64位。当需要使用一个整数时，首选<code>int</code>，仅当有特殊情况时才使用定长整数类型或者无符号整数类型。</p>
<p>下面的例子展示了不同类型的变量，与<code>打包</code>导入一样，变量定义打包在一个语法块中。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"math/cmplx"</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">var</span>(</span><br><span class="line">	Flag <span class="keyword">bool</span> = <span class="literal">false</span></span><br><span class="line">  	MaxInt unit64 = <span class="number">1</span> &lt;&lt; <span class="number">64</span> - <span class="number">1</span></span><br><span class="line">  	z <span class="keyword">complex128</span> = cmplx.Sqrt(<span class="number">-5</span> + <span class="number">12i</span>)</span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">const</span> f = <span class="string">"%T(%v)\n"</span></span><br><span class="line">  fmt.Printf(f, Flag, Flag)</span><br><span class="line">  fmt.Printf(f, MaxInt, MaxInt)</span><br><span class="line">  fmt.Printf(f, z, z)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line"><span class="keyword">bool</span>(<span class="literal">false</span>)</span><br><span class="line"><span class="keyword">uint64</span>(<span class="number">18446744073709551615</span>)</span><br><span class="line"><span class="keyword">complex128</span>((<span class="number">2</span>+<span class="number">3i</span>))</span><br></pre></td></tr></table></figure>
<p>表达式<code>T(v)</code>将值v转换为类型T，比如下列的数值转换：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> i <span class="keyword">int</span> = <span class="number">42</span></span><br><span class="line"><span class="keyword">var</span> f <span class="keyword">float64</span> = <span class="keyword">float64</span>(i)</span><br><span class="line"><span class="keyword">var</span> u <span class="keyword">uint</span> = <span class="keyword">uint</span>(f)</span><br><span class="line"></span><br><span class="line">or simple</span><br><span class="line">i := <span class="number">42</span></span><br><span class="line">f := <span class="keyword">float64</span>(i)</span><br><span class="line">u := <span class="keyword">uint</span>(f)</span><br></pre></td></tr></table></figure>
<p>与C语言不同的是，Go在不同类型的变量之间赋值时需要进行显示转换。比如下面的例子中，未将<code>x*x+y*y</code>显示转换成<code>float64</code>而报错。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"math"</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> x, y <span class="keyword">int</span> = <span class="number">3</span>, <span class="number">4</span></span><br><span class="line">	<span class="keyword">var</span> f <span class="keyword">float64</span> = math.Sqrt((x*x + y*y))</span><br><span class="line">	<span class="keyword">var</span> z <span class="keyword">uint</span> = <span class="keyword">uint</span>(f)</span><br><span class="line">	fmt.Println(x, y, z)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">tmp/sandbox259072833/main.<span class="keyword">go</span>:<span class="number">10</span>: cannot use x * x + y * y (<span class="keyword">type</span> <span class="keyword">int</span>) as <span class="keyword">type</span> <span class="keyword">float64</span> in argument to math.Sqrt</span><br></pre></td></tr></table></figure>
<p>定义一个变量却不显示指定其类型时(使用<code>:=</code>或者<code>var =</code>表达式语法)，变量的类型由右侧的值推到得出。<br>当右侧的数值定义了类型时，新变量的类型与其相同，如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> i <span class="keyword">int</span></span><br><span class="line">j := i <span class="comment">// j 也是一个 int</span></span><br></pre></td></tr></table></figure>
<p>但是当右侧的数值包含了未指明类型的数字常量时，新变量可能是int，float64或者complex128。这取决于常量的精度：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">i := <span class="number">42</span>           <span class="comment">// int</span></span><br><span class="line">f := <span class="number">3.142</span>        <span class="comment">// float64</span></span><br><span class="line">g := <span class="number">0.867</span> + <span class="number">0.5i</span> <span class="comment">// complex128</span></span><br></pre></td></tr></table></figure>
<p>在Go中，常量的定义使用<code>const</code>关键字，常量可以是字符，字符串，布尔或者数字类型的值，但是不可以用<code>:=</code>语法定义。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="keyword">const</span> Pi = <span class="number">3.14</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">const</span> World = <span class="string">"世界"</span></span><br><span class="line">  fmt.Println(<span class="string">"Hello"</span>, World)</span><br><span class="line">  fmt.Println(<span class="string">"Happy"</span>, Pi, <span class="string">"Day"</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> Truth = <span class="literal">true</span></span><br><span class="line">  fmt.Println(<span class="string">"Go rules?"</span>, Truth)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">Hello 世界</span><br><span class="line">Happy <span class="number">3.14</span> Day</span><br><span class="line">Go rules? <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>数值常量一般是高精度的<code>值</code>。一个未指定类型的常量由上下文来决定其类型。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line">   <span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line">   <span class="keyword">const</span>(</span><br><span class="line">   	Big = <span class="number">1</span> &lt;&lt; <span class="number">100</span></span><br><span class="line">     	Small = Big &gt;&gt; <span class="number">99</span></span><br><span class="line">   )</span><br><span class="line">   <span class="function"><span class="keyword">func</span> <span class="title">needInt</span><span class="params">(x <span class="keyword">int</span>)</span><span class="title">int</span></span>&#123;</span><br><span class="line">     	<span class="keyword">return</span> x * <span class="number">10</span> + <span class="number">1</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">func</span> <span class="title">needFloat</span><span class="params">(x <span class="keyword">float64</span>)</span><span class="title">float64</span></span>&#123;</span><br><span class="line">     	<span class="keyword">return</span> x * <span class="number">0.1</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">     	fmt.Println(needInt(Small))</span><br><span class="line">     	fmt.Println(needFloat(Small))</span><br><span class="line">    	 fmt.Println(needFloat(Big))</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   output:</span><br><span class="line">   <span class="number">21</span></span><br><span class="line">   <span class="number">0.2</span></span><br><span class="line">   <span class="number">1.2676506002282295e+29</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="流程控制语句"><a href="#流程控制语句" class="headerlink" title="流程控制语句"></a>流程控制语句</h3><ol>
<li><p>Go只有一种循环结构<code>for</code>。基本<code>for</code>循环包含三个由分号分开的组成部分：</p>
<ul>
<li>初始化语句：在第一次循环执行前被执行</li>
<li>循环条件表达式：每轮迭代开始前被求值</li>
<li>后置语句：每轮迭代后执行</li>
</ul>
<p>初始化语句一般是一个短变量声明，该变量仅在整个循环语句中可见。如果表达式的值变为false，迭代终止。与C，Java等语言不同的是，<code>for</code>语句的三个组成部分并不需要用括号括起来，但循环体必须用<code>{ }</code>括起来。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	sum := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">		sum += i</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(sum)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line"><span class="number">45</span></span><br></pre></td></tr></table></figure>
<p>此外，循环的初始化语句与后置语句均是可选的，比如上面的例子可以改写成：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sum := <span class="number">1</span> </span><br><span class="line"><span class="keyword">for</span> ; sum &lt; <span class="number">1000</span>; &#123;</span><br><span class="line">    sum += sum</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>基于以上，可以省略分号，则功能类似于其他语言中的<code>while</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sum := <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span>　sum &lt; <span class="number">1000</span> &#123;</span><br><span class="line">     sum += sum</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若省略了循环条件，循环不会结束，因此可用更简洁的方式表达死循环。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>与<code>for</code>一样，Go的<code>if</code>语句也不要求用<code>( )</code>将条件括起来，但是还是需要用<code>{ }</code>将语句块括起来。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span>(</span><br><span class="line">  <span class="string">"fmt"</span></span><br><span class="line">  <span class="string">"math"</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sqrt</span><span class="params">(x <span class="keyword">float64</span>)</span><span class="title">string</span></span>&#123;</span><br><span class="line">  	<span class="keyword">if</span> x &lt; <span class="number">0</span> &#123;</span><br><span class="line">      	<span class="keyword">return</span> sqrt(-x)+ <span class="string">"i"</span></span><br><span class="line">  	&#125;</span><br><span class="line">  	<span class="keyword">return</span> fmt.Sprint(math.Sqrt(x))</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  	fmt.Println(sqrt(<span class="number">2</span>), sqrt(<span class="number">-4</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br></pre></td></tr></table></figure>
<p><code>if</code>语句可以在条件之前执行一个简单语句，该语句定义的变量的作用域仅在<code>if</code>范围之内，比如下面的例子，若把<code>return lim</code>改成<code>return v</code>便会报错。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"math"</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">pow</span><span class="params">(x, n , lim <span class="keyword">float64</span>)</span><span class="title">float64</span></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> v := math.Pow(x, n); v &lt; lim　&#123;</span><br><span class="line">    	<span class="keyword">return</span> v</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> lim</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  	fmt.Println(</span><br><span class="line">    	pow(<span class="number">3</span>, <span class="number">2</span>, <span class="number">10</span>),</span><br><span class="line">      	pow(<span class="number">3</span>, <span class="number">3</span>, <span class="number">20</span>)</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line"><span class="number">9</span> <span class="number">20</span></span><br></pre></td></tr></table></figure>
<p>在<code>if</code>的便捷语句定义的变量同样可以在任何对应的<code>else</code>块中使用。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"math"</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">pow</span><span class="params">(x, n, lim <span class="keyword">float64</span>)</span> <span class="title">float64</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> v := math.Pow(x, n); v &lt; lim &#123;</span><br><span class="line">		<span class="keyword">return</span> v</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"%g &gt;= %g\n"</span>, v, lim)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 这里开始就不能使用 v 了</span></span><br><span class="line">	<span class="keyword">return</span> lim</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(</span><br><span class="line">		pow(<span class="number">3</span>, <span class="number">2</span>, <span class="number">10</span>),</span><br><span class="line">		pow(<span class="number">3</span>, <span class="number">3</span>, <span class="number">20</span>),</span><br><span class="line">	)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line"><span class="number">27</span> &gt;= <span class="number">20</span> <span class="comment">//需要注意的是，两个pow调用都在main调用fmt.Println前执行完毕了。</span></span><br><span class="line"><span class="number">9</span> <span class="number">20</span></span><br></pre></td></tr></table></figure>
<p>练习：循环和函数。</p>
<blockquote>
<p>作为练习函数和循环的简单途径，用牛顿法实现开方函数。</p>
<p>在这个例子中，牛顿法是通过一个初始点z，然后然后重复以下过程求Sqrt(x)的近似值：</p>
<p>$z = z - \frac{z^2-x}{2z}$</p>
<p>为了做到这个，只需要重复计算10次。并且观察不同的值(1,2,3,…)是如何逐步逼近结果的。然后，修改循环条件，使得当值停止改变(或者改变非常小)的时候退出循环。观察迭代次数是否变化。结果与math.Sqrt接近吗？</p>
</blockquote>
<p>指定迭代次数版本：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sqrt</span><span class="params">(x <span class="keyword">float64</span>)</span> <span class="title">float64</span></span> &#123;</span><br><span class="line">	z:=<span class="keyword">float64</span>(<span class="number">1</span>)</span><br><span class="line">	<span class="keyword">for</span> i:=<span class="number">1</span>;i&lt;<span class="number">10</span>;i++ &#123;</span><br><span class="line">		z = z - (z*z-x)/(<span class="number">2</span>*z)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> z</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(Sqrt(<span class="number">2</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line"><span class="number">1.4142135623730951</span></span><br></pre></td></tr></table></figure>
<p>无限逼近版本：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sqrt</span><span class="params">(x <span class="keyword">float64</span>)</span> <span class="title">float64</span></span> &#123;</span><br><span class="line">	z:=<span class="keyword">float64</span>(<span class="number">1</span>)</span><br><span class="line">	y:= z - (z*z-x)/(<span class="number">2</span>*z)</span><br><span class="line">	<span class="keyword">for</span> math.Abs(y-z)&gt; <span class="number">1e-10</span> &#123;</span><br><span class="line">		z = y ;</span><br><span class="line">		y = z - (z*z-x)/(<span class="number">2</span>*z)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> y</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line"><span class="number">1.4142135623730951</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>switch</code>分支语句，除非以<code>fallthrough</code>语句结束，否则分支会自动终止。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"runtime"</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Print(<span class="string">"Go runs on "</span>)</span><br><span class="line">	<span class="keyword">switch</span> os := runtime.GOOS; os &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">"darwin"</span>:</span><br><span class="line">		fmt.Println(<span class="string">"OS X."</span>)</span><br><span class="line">	<span class="keyword">case</span> <span class="string">"linux"</span>:</span><br><span class="line">		fmt.Println(<span class="string">"Linux."</span>)</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="comment">// freebsd, openbsd,</span></span><br><span class="line">		<span class="comment">// plan9, windows...</span></span><br><span class="line">		fmt.Printf(<span class="string">"%s."</span>, os)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">Go runs on nacl.</span><br></pre></td></tr></table></figure>
<p><code>switch</code>的条件从上到下的执行，当匹配成功的时候停止。例如，</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> i &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">0</span> :</span><br><span class="line">  	<span class="keyword">case</span> f() :</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当i==0时不会调用f。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">"When's Saturday?"</span>)</span><br><span class="line">	today := time.Now().Weekday()<span class="comment">//计算当前的星期几</span></span><br><span class="line">	<span class="keyword">switch</span> time.Saturday &#123;</span><br><span class="line">		<span class="keyword">case</span> today + <span class="number">0</span>:</span><br><span class="line">			fmt.Println(<span class="string">"Today."</span>)</span><br><span class="line">		<span class="keyword">case</span> today + <span class="number">1</span>:</span><br><span class="line">			fmt.Println(<span class="string">"Tomorrow."</span>)</span><br><span class="line">		<span class="keyword">case</span> today + <span class="number">2</span>:</span><br><span class="line">			fmt.Println(<span class="string">"In two days."</span>)</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			fmt.Println(<span class="string">"Too far away."</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">When<span class="string">'s Saturday?</span></span><br><span class="line"><span class="string">Too far away.</span></span><br></pre></td></tr></table></figure>
<p>没有条件的switch与<code>switch　true</code>一样。这一构造使得可以用更清晰的形式来编写长的<code>it-then-elese</code>链。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span>(</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">  	<span class="string">"math"</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  	t := time.Now()</span><br><span class="line">  	<span class="keyword">switch</span> &#123;</span><br><span class="line">      	<span class="keyword">case</span> t.Hour() &lt; <span class="number">12</span>:</span><br><span class="line">      		fmt.Println(<span class="string">"Good Morning!"</span>)</span><br><span class="line">      	<span class="keyword">case</span> t.Hour &lt; <span class="number">17</span> :</span><br><span class="line">      		fmt.Println(<span class="string">"Good Afternoon!"</span>)</span><br><span class="line">      	<span class="keyword">default</span>:</span><br><span class="line">      		fmt.Println(<span class="string">"Good Evening!"</span>)</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">Good Morning!</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>defer</code>语句会延迟函数的执行，直到上层函数返回，延迟调用的参数会立刻生成，但是在上层函数返回前，函数都不会调用。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> fmt.Println(<span class="string">"world"</span>)</span><br><span class="line">	fmt.Println(<span class="string">"hello"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">hello</span><br><span class="line">world</span><br></pre></td></tr></table></figure>
<p>延迟的函数调用被压入一个栈中，当函数返回时，会按照先进后出的顺序调用被延迟的函数。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  	fmt.Println(<span class="string">"counting"</span>)</span><br><span class="line">  	<span class="keyword">for</span> i := <span class="number">0</span> ; i &lt; <span class="number">10</span> ; i++ &#123;</span><br><span class="line">      	<span class="keyword">defer</span> fmt.Println(i)</span><br><span class="line">  	&#125;</span><br><span class="line">  	fmt.Println(<span class="string">"done"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">counting</span><br><span class="line">done</span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="复杂类型"><a href="#复杂类型" class="headerlink" title="复杂类型"></a>复杂类型</h3><ol>
<li><p>Go使用<code>pointer</code>来保存变量的内存地址，即指针。类型<code>* T</code>是指向类型T的值的指针，默认值为<code>nil</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> p *<span class="keyword">int</span></span><br></pre></td></tr></table></figure>
<p><code>＆</code>符号会生成一个指向其作用对象的指针。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">i := <span class="number">42</span></span><br><span class="line">p = &amp;i</span><br></pre></td></tr></table></figure>
<p><code>*</code>符号表示指针指向的底层的值</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fmt.Println(*p) <span class="comment">// 通过指针p读取i</span></span><br><span class="line">*p = <span class="number">21</span> <span class="comment">//通过指针p设置i</span></span><br></pre></td></tr></table></figure>
<p>以上就是常说的间接引用与或非直接引用。与C不同的是，Go没有指针运算。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  	i, j := <span class="number">42</span>, <span class="number">2701</span></span><br><span class="line"> 	p := &amp;i</span><br><span class="line">  	fmt.Println(*p)<span class="comment">//通过指针读取i的值</span></span><br><span class="line">  	*p = <span class="number">21</span> <span class="comment">//通过指针修改i的值</span></span><br><span class="line">  	p = &amp;j <span class="comment">//修改指针的指向</span></span><br><span class="line">  	*p = *p / <span class="number">37</span> <span class="comment">// 修改j的值</span></span><br><span class="line">  	fmt.Println(j)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line"><span class="number">42</span></span><br><span class="line"><span class="number">21</span></span><br><span class="line"><span class="number">73</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>结构体<code>struct</code>是一个字段的集合，如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="comment">//定义一个坐标的结构体</span></span><br><span class="line"><span class="keyword">type</span> Vertex <span class="keyword">struct</span>&#123;</span><br><span class="line">  	X <span class="keyword">int</span></span><br><span class="line">  	Y <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  	fmt.Println(Vertex&#123;<span class="number">1</span>,<span class="number">2</span>&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">&#123;<span class="number">1</span> <span class="number">2</span>&#125;</span><br></pre></td></tr></table></figure>
<p>结构体字段使用点号进行访问。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">v := Vertex&#123;<span class="number">1</span>, <span class="number">2</span>&#125;</span><br><span class="line">v.X = <span class="number">4</span></span><br><span class="line">fmt.Println(v.X)</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line"><span class="number">4</span></span><br></pre></td></tr></table></figure>
<p>结构体字段也可以通过指针来访问，通过指针间接的访问是透明的。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">v := Vertex&#123;<span class="number">1</span>, <span class="number">2</span>&#125;</span><br><span class="line">p := &amp;v</span><br><span class="line">p.X = <span class="number">1e9</span></span><br><span class="line">fmt.Println(v)</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">&#123;<span class="number">1000000000</span> <span class="number">2</span>&#125;</span><br></pre></td></tr></table></figure>
<p>结构体文法表示通过结构体字段的值作为列表来分配一个结构体。语法可以只列出部分字段。字段名的顺序无关。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span>(</span><br><span class="line">	v1 = Vertex&#123;<span class="number">1</span>, <span class="number">2</span>&#125;</span><br><span class="line">  	v2 = Vertex&#123;X : <span class="number">1</span>&#125; <span class="comment">//Y : 0 被省略</span></span><br><span class="line">  	v3 = Vertex&#123; &#125; <span class="comment">//X : 0 和 Y : 0</span></span><br><span class="line">  	p = &amp;Vertex&#123;<span class="number">1</span>, <span class="number">2</span>&#125; <span class="comment">//类型为*Vertex</span></span><br><span class="line">)</span><br><span class="line">fmt.Println(v1, p ,v2, v3)</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">&#123;<span class="number">1</span> <span class="number">2</span>&#125; &amp;&#123;<span class="number">1</span> <span class="number">2</span>&#125; &#123;<span class="number">1</span> <span class="number">0</span>&#125; &#123;<span class="number">0</span> <span class="number">0</span>&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>数组是一个有n个类型为T的值的集合，记为<code>[n]T</code>。表达式<code>var a [10]int</code> 定义变量a是一个有十个整数的数组。数组的长度是类型的一部分，因此数组一旦定义不能改变大小。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  	<span class="keyword">var</span> a [<span class="number">2</span>]<span class="keyword">string</span></span><br><span class="line">  	a[<span class="number">0</span>] = <span class="string">"Hello"</span></span><br><span class="line">  	a[<span class="number">1</span>] = <span class="string">"World"</span></span><br><span class="line">  	fmt.Println(a[<span class="number">0</span>],a[<span class="number">1</span>])</span><br><span class="line"> 	fmt.Prinlnt(a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">Hello World</span><br><span class="line">[Hello World]</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>[n]T</code>指向一个序列的值，并包含长度信息。数组<code>[]T</code>是一个元素类型为T的slice。<code>len(s)</code>返回slice s的长度。slice的零值为nil，其长度和容量均为0。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  	s := []<span class="keyword">int</span>&#123;<span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span> ,<span class="number">11</span>, <span class="number">13</span>&#125;</span><br><span class="line">  	fmt.Println(<span class="string">"s == "</span>, s)</span><br><span class="line">  	<span class="keyword">for</span> i := <span class="number">0</span> ; i &lt; <span class="built_in">len</span>(s); i++ &#123;</span><br><span class="line">      	fmt.Println(<span class="string">"s[%d] == %d\n"</span>, i, s[i])</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">s == [<span class="number">2</span> <span class="number">3</span> <span class="number">5</span> <span class="number">7</span> <span class="number">11</span> <span class="number">13</span>]</span><br><span class="line">s[<span class="number">0</span>] == <span class="number">2</span></span><br><span class="line">s[<span class="number">1</span>] == <span class="number">3</span></span><br><span class="line">s[<span class="number">2</span>] == <span class="number">5</span></span><br><span class="line">s[<span class="number">3</span>] == <span class="number">7</span></span><br><span class="line">s[<span class="number">4</span>] == <span class="number">11</span></span><br><span class="line">s[<span class="number">5</span>] == <span class="number">13</span></span><br></pre></td></tr></table></figure>
<p>slice可以包含任意类型的元素，包括另外一个slice。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"strings"</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printBoard</span><span class="params">(s [][]<span class="keyword">string</span>)</span></span>&#123;</span><br><span class="line">  	<span class="keyword">for</span> i := <span class="number">0</span> ; i &lt; <span class="built_in">len</span>(s) ; i++ &#123;</span><br><span class="line">      	fmt.Printf(<span class="string">"%s\n"</span>, strings.Join(s[i], <span class="string">" "</span>))</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  	game := [][]<span class="keyword">string</span>&#123;</span><br><span class="line">      	[]<span class="keyword">string</span>&#123;<span class="string">"_"</span>, <span class="string">"_"</span>. <span class="string">"_"</span>&#125;,</span><br><span class="line">        []<span class="keyword">string</span>&#123;<span class="string">"_"</span>, <span class="string">"_"</span>. <span class="string">"_"</span>&#125;,</span><br><span class="line">        []<span class="keyword">string</span>&#123;<span class="string">"_"</span>, <span class="string">"_"</span>. <span class="string">"_"</span>&#125;,</span><br><span class="line">  	&#125;</span><br><span class="line">  	game[<span class="number">0</span>][<span class="number">0</span>] = <span class="string">"X"</span></span><br><span class="line">  	game[<span class="number">2</span>][<span class="number">2</span>] = <span class="string">"O"</span></span><br><span class="line">    game[<span class="number">2</span>][<span class="number">0</span>] = <span class="string">"X"</span></span><br><span class="line">    game[<span class="number">1</span>][<span class="number">0</span>] = <span class="string">"O"</span></span><br><span class="line">  	game[<span class="number">0</span>][<span class="number">2</span>] = <span class="string">"X"</span></span><br><span class="line">  	printBoard(game)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">X _ X</span><br><span class="line">O _ _</span><br><span class="line">X _ O</span><br></pre></td></tr></table></figure>
<p>slice可以重新切片，创建一个新的slice值指向相同的数组。表达式<code>s[lo:hi]</code>表示从lo到hi-1的slice元素，含前端，不包含后端，因此，<code>s[lo:lo]</code>是空，<code>s[lo:lo+1]</code>有一个元素。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  	s := []<span class="keyword">int</span>&#123;<span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">13</span>&#125;</span><br><span class="line">  	fmt.Println(<span class="string">"s =="</span>, s)</span><br><span class="line">  	fmt.Println(<span class="string">"s[1:4] == "</span>, s[<span class="number">1</span> : <span class="number">4</span>])</span><br><span class="line">  	<span class="comment">//省略前端，表示从0开始</span></span><br><span class="line">  	fmt.Println(<span class="string">"s[:3] =="</span>, s[:<span class="number">3</span>])</span><br><span class="line">  	<span class="comment">//省略后端，表示从当前位置开始，到len(s)结束</span></span><br><span class="line">  	fmt.Println(<span class="string">"s[4:] =="</span>, s[<span class="number">4</span>:])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">s == [<span class="number">2</span> <span class="number">3</span> <span class="number">5</span> <span class="number">7</span> <span class="number">11</span> <span class="number">13</span>]</span><br><span class="line">s[<span class="number">1</span>:<span class="number">4</span>] == [<span class="number">3</span> <span class="number">5</span> <span class="number">7</span>]</span><br><span class="line">s[:<span class="number">3</span>] == [<span class="number">2</span> <span class="number">3</span> <span class="number">5</span>]</span><br><span class="line">s[<span class="number">4</span>:] == [<span class="number">11</span> <span class="number">13</span>]</span><br></pre></td></tr></table></figure>
<p>可以使用函数<code>make</code>创建slice。这会分配一个全为零值的数组，并返回一个slice指向这个数组：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">5</span>)</span><br></pre></td></tr></table></figure>
<p>为了指定容量，可以传递第三个参数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printSlice</span><span class="params">(s <span class="keyword">string</span>, x []<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">"%s len=%d cap=%d %v\n"</span>,</span><br><span class="line">		s, <span class="built_in">len</span>(x), <span class="built_in">cap</span>(x), x)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	a := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">5</span>)</span><br><span class="line">	printSlice(<span class="string">"a"</span>, a)</span><br><span class="line">	b := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, <span class="number">5</span>)</span><br><span class="line">	printSlice(<span class="string">"b"</span>, b)</span><br><span class="line">	c := b[:<span class="number">2</span>]</span><br><span class="line">	printSlice(<span class="string">"c"</span>, c)</span><br><span class="line">	d := c[<span class="number">2</span>:<span class="number">5</span>]</span><br><span class="line">	printSlice(<span class="string">"d"</span>, d)</span><br><span class="line">｝</span><br><span class="line">  </span><br><span class="line">output:</span><br><span class="line">a <span class="built_in">len</span>=<span class="number">5</span> <span class="built_in">cap</span>=<span class="number">5</span> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line">b <span class="built_in">len</span>=<span class="number">0</span> <span class="built_in">cap</span>=<span class="number">5</span> []</span><br><span class="line">c <span class="built_in">len</span>=<span class="number">2</span> <span class="built_in">cap</span>=<span class="number">5</span> [<span class="number">0</span> <span class="number">0</span>]</span><br><span class="line">d <span class="built_in">len</span>=<span class="number">3</span> <span class="built_in">cap</span>=<span class="number">3</span> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<p>向slice的末尾添加元素是一种常见的操作，使用函数<code>append(s []T, vs ...T)[]T</code>，第一个参数s是一个类型为T的slice，其余类型为T的值会附加到该slice的末尾，返回一个包含原slice所有元素加上新添加的元素的slice。如果s的底层数组太小，而不能容纳所有值时，会分配一个更大的数组，返回的slice会指向这个新分配的数组。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printSlice</span><span class="params">(s <span class="keyword">string</span>, x []<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">"%s len=%d cap=%d %v\n"</span>,</span><br><span class="line">		s, <span class="built_in">len</span>(x), <span class="built_in">cap</span>(x), x)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  	<span class="keyword">var</span> a []<span class="keyword">int</span></span><br><span class="line">  	printSlice(<span class="string">"a"</span>, a)</span><br><span class="line">  	a = <span class="built_in">append</span>(a, <span class="number">0</span>)</span><br><span class="line">  	printSlice(<span class="string">"a"</span>, a)</span><br><span class="line">  	a = <span class="built_in">append</span>(a, <span class="number">1</span>)</span><br><span class="line">  	printSlice(<span class="string">"a"</span>, a)</span><br><span class="line">  	a = <span class="built_in">append</span>(a, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">  	printSlice(<span class="string">"a"</span>, a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">a <span class="built_in">len</span>=<span class="number">0</span> <span class="built_in">cap</span>=<span class="number">0</span> []</span><br><span class="line">a <span class="built_in">len</span>=<span class="number">1</span> <span class="built_in">cap</span>=<span class="number">2</span> [<span class="number">0</span>]</span><br><span class="line">a <span class="built_in">len</span>=<span class="number">2</span> <span class="built_in">cap</span>=<span class="number">2</span> [<span class="number">0</span> <span class="number">1</span>]</span><br><span class="line">a <span class="built_in">len</span>=<span class="number">5</span> <span class="built_in">cap</span>=<span class="number">8</span> [<span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>for</code>循环的<code>range</code>格式可以对slice或者map进行迭代循环。当使用<code>for</code>循环遍历一个slice时，每次迭代<code>range</code>将返回两个值，一个是当前下标，一个是该下标所对应元素的一个拷贝。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="keyword">var</span> pow = []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">8</span>, <span class="number">16</span> ,<span class="number">32</span>, <span class="number">64</span>, <span class="number">128</span>&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  	<span class="keyword">for</span> i, v := <span class="keyword">range</span> pow &#123;</span><br><span class="line">      	fmt.Printf(<span class="string">"2**%d = %d\n"</span>, i, v)</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line"><span class="number">2</span>**<span class="number">0</span> = <span class="number">1</span></span><br><span class="line"><span class="number">2</span>**<span class="number">1</span> = <span class="number">2</span></span><br><span class="line"><span class="number">2</span>**<span class="number">2</span> = <span class="number">4</span></span><br><span class="line"><span class="number">2</span>**<span class="number">3</span> = <span class="number">8</span></span><br><span class="line"><span class="number">2</span>**<span class="number">4</span> = <span class="number">16</span></span><br><span class="line"><span class="number">2</span>**<span class="number">5</span> = <span class="number">32</span></span><br><span class="line"><span class="number">2</span>**<span class="number">6</span> = <span class="number">64</span></span><br><span class="line"><span class="number">2</span>**<span class="number">7</span> = <span class="number">128</span></span><br></pre></td></tr></table></figure>
<p>练习：slice</p>
<blockquote>
<p>实现Pic。返回一个长度为dy的slice，其中每个元素是一个长度为dx且元素类型为8位无符号整数的slice。在运行程序时，它会将每个整数作为对应像素的灰度值，并显示这个slice所对应的图像。</p>
<p>计算每个像素的灰度值的方法由你决定；几个有意思的选择包括 <code>(x+y)/2</code>、<code>x*y</code> 和 <code>x^y</code> 。</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"golang.org/x/tour/pic"</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Pic</span><span class="params">(dx, dy <span class="keyword">int</span>)</span> [][]<span class="title">uint8</span></span> &#123;</span><br><span class="line">    result := <span class="built_in">make</span>([][]<span class="keyword">uint8</span>, dy)</span><br><span class="line">    <span class="keyword">for</span> i:= <span class="number">0</span> ; i &lt; dy ; i++ &#123;</span><br><span class="line">          result[i] = <span class="built_in">make</span>([]<span class="keyword">uint8</span>, dx)</span><br><span class="line">          <span class="keyword">for</span> j := <span class="number">0</span> ;j &lt; dx ; j++ &#123;</span><br><span class="line">              result[i][j] = <span class="keyword">uint8</span>(i*j)</span><br><span class="line">          &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	pic.Show(Pic)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>map</code>映射键到值，使用<code>make</code>函数来创建，值为<code>nil</code>的map是空的，并且不能对其赋值。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="keyword">type</span> Vertex <span class="keyword">struct</span>&#123;</span><br><span class="line">  	Lat, Long <span class="keyword">float64</span></span><br><span class="line">&#125;<span class="comment">//经纬度结构体</span></span><br><span class="line"><span class="keyword">var</span> m <span class="keyword">map</span>[<span class="keyword">string</span>]Vertex　<span class="comment">//string到struct的映射</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  	m = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]Vertex)</span><br><span class="line">  	m[<span class="string">"Bell Labs"</span>] = Vertex&#123;</span><br><span class="line">      	<span class="number">40.68433</span>, <span class="number">-74.39967</span>,</span><br><span class="line">  	&#125;</span><br><span class="line">  	fmt.Println(m[<span class="string">"Bell Labs"</span>])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">&#123;<span class="number">40.68433</span> <span class="number">-74.39967</span>&#125;</span><br></pre></td></tr></table></figure>
<p>map的文法与struct类似，但是必须要有键名。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="keyword">type</span> Vertex <span class="keyword">struct</span>&#123;</span><br><span class="line">  	Lat, Long <span class="keyword">float64</span></span><br><span class="line">&#125;<span class="comment">//经纬度结构体</span></span><br><span class="line"><span class="keyword">var</span> m = <span class="keyword">map</span>[<span class="keyword">string</span>]Vertex&#123;</span><br><span class="line">  	<span class="string">"Bell Labs"</span> : Vertex&#123;</span><br><span class="line">      	<span class="number">40.68433</span>, <span class="number">-74.39967</span>,<span class="comment">//逗号不可少</span></span><br><span class="line">  	&#125;,</span><br><span class="line"> 	 <span class="string">"Google"</span> : Vertex&#123;</span><br><span class="line">       	<span class="number">37.42202</span>, <span class="number">-122.08408</span>,<span class="comment">//逗号不可少</span></span><br><span class="line"> 	 &#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  	fmt.Println(m)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line"><span class="keyword">map</span>[Bell Labs:&#123;<span class="number">40.68433</span> <span class="number">-74.39967</span>&#125; Google:&#123;<span class="number">37.42202</span> <span class="number">-122.08408</span>&#125;]</span><br></pre></td></tr></table></figure>
<p>顶级类型只是一个类型名，可以在文法的元素中省略它。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="keyword">type</span> Vertex <span class="keyword">struct</span>&#123;</span><br><span class="line">  	Lat, Long <span class="keyword">float64</span></span><br><span class="line">&#125;<span class="comment">//经纬度结构体</span></span><br><span class="line"><span class="keyword">var</span> m = <span class="keyword">map</span>[<span class="keyword">string</span>]Vertex&#123;</span><br><span class="line"> 	 <span class="string">"Bell Labs"</span> : &#123;<span class="number">40.68433</span>, <span class="number">-74.39967</span>&#125;,</span><br><span class="line"> 	 <span class="string">"Google"</span>:    &#123;<span class="number">37.42202</span>, <span class="number">-122.08408</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  	fmt.Println(m)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line"><span class="keyword">map</span>[Bell Labs:&#123;<span class="number">40.68433</span> <span class="number">-74.39967</span>&#125; Google:&#123;<span class="number">37.42202</span> <span class="number">-122.08408</span>&#125;]</span><br></pre></td></tr></table></figure>
<p>在map中插入，删除元素，检测元素是否存在。当从map中读取某个不存在的键时，结果是map的元素类型的零值。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	m := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>)</span><br><span class="line">	m[<span class="string">"Answer"</span>] = <span class="number">42</span></span><br><span class="line">	fmt.Println(<span class="string">"The value:"</span>, m[<span class="string">"Answer"</span>])</span><br><span class="line">	m[<span class="string">"Answer"</span>] = <span class="number">48</span></span><br><span class="line">	fmt.Println(<span class="string">"The value:"</span>, m[<span class="string">"Answer"</span>])</span><br><span class="line">	<span class="built_in">delete</span>(m, <span class="string">"Answer"</span>)</span><br><span class="line">	fmt.Println(<span class="string">"The value:"</span>, m[<span class="string">"Answer"</span>])</span><br><span class="line">	v, ok := m[<span class="string">"Answer"</span>]</span><br><span class="line">	fmt.Println(<span class="string">"The value:"</span>, v, <span class="string">"Present?"</span>, ok)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">The value: <span class="number">42</span></span><br><span class="line">The value: <span class="number">48</span></span><br><span class="line">The value: <span class="number">0</span></span><br><span class="line">The value: <span class="number">0</span> Present? <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>练习：map</p>
<blockquote>
<p>实现WordCount。它应当返回一个含有 <code>s</code> 中每个 “词” 个数的 map。函数 <code>wc.Test</code> 针对这个函数执行一个测试用例，并输出成功还是失败。</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"golang.org/x/tour/wc"</span></span><br><span class="line">	<span class="string">"strings"</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WordCount</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">map</span>[<span class="title">string</span>]<span class="title">int</span></span> &#123;</span><br><span class="line">	 result := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>)</span><br><span class="line">     words := strings.Fields(s)</span><br><span class="line">     <span class="keyword">for</span> _, word := <span class="keyword">range</span> words &#123;</span><br><span class="line">          result[word]++</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	wc.Test(WordCount)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">PASS</span><br><span class="line"> f(<span class="string">"I am learning Go!"</span>) = </span><br><span class="line">  <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>&#123;<span class="string">"I"</span>:<span class="number">1</span>, <span class="string">"am"</span>:<span class="number">1</span>, <span class="string">"learning"</span>:<span class="number">1</span>, <span class="string">"Go!"</span>:<span class="number">1</span>&#125;</span><br><span class="line">PASS</span><br><span class="line"> f(<span class="string">"The quick brown fox jumped over the lazy dog."</span>) = </span><br><span class="line">  <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>&#123;<span class="string">"dog."</span>:<span class="number">1</span>, <span class="string">"the"</span>:<span class="number">1</span>, <span class="string">"quick"</span>:<span class="number">1</span>, <span class="string">"brown"</span>:<span class="number">1</span>, <span class="string">"fox"</span>:<span class="number">1</span>, <span class="string">"jumped"</span>:<span class="number">1</span>, <span class="string">"over"</span>:<span class="number">1</span>, <span class="string">"lazy"</span>:<span class="number">1</span>, <span class="string">"The"</span>:<span class="number">1</span>&#125;</span><br><span class="line">PASS</span><br><span class="line"> f(<span class="string">"I ate a donut. Then I ate another donut."</span>) = </span><br><span class="line">  <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>&#123;<span class="string">"donut."</span>:<span class="number">2</span>, <span class="string">"Then"</span>:<span class="number">1</span>, <span class="string">"another"</span>:<span class="number">1</span>, <span class="string">"I"</span>:<span class="number">2</span>, <span class="string">"ate"</span>:<span class="number">2</span>, <span class="string">"a"</span>:<span class="number">1</span>&#125;</span><br><span class="line">PASS</span><br><span class="line"> f(<span class="string">"A man a plan a canal panama."</span>) = </span><br><span class="line">  <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>&#123;<span class="string">"canal"</span>:<span class="number">1</span>, <span class="string">"panama."</span>:<span class="number">1</span>, <span class="string">"A"</span>:<span class="number">1</span>, <span class="string">"man"</span>:<span class="number">1</span>, <span class="string">"a"</span>:<span class="number">2</span>, <span class="string">"plan"</span>:<span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>函数也是值。可以像其他值一样传递，比如函数值可以作为函数的参数或者返回值。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"math"</span></span><br><span class="line">)</span><br><span class="line"><span class="comment">//函数作为参数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">compute</span><span class="params">(fn <span class="keyword">func</span>(<span class="keyword">float64</span>, <span class="keyword">float64</span>)</span> <span class="title">float64</span>) <span class="title">float64</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> fn(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  	<span class="comment">//函数作为返回值</span></span><br><span class="line">	hypot := <span class="function"><span class="keyword">func</span><span class="params">(x, y <span class="keyword">float64</span>)</span> <span class="title">float64</span></span> &#123;</span><br><span class="line">		<span class="keyword">return</span> math.Sqrt(x*x + y*y)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(hypot(<span class="number">5</span>, <span class="number">12</span>))<span class="comment">//求平方和</span></span><br><span class="line">	fmt.Println(compute(hypot))<span class="comment">//求平方和</span></span><br><span class="line">	fmt.Println(compute(math.Pow))<span class="comment">//求3的4次方</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line"><span class="number">13</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">81</span></span><br></pre></td></tr></table></figure>
<p>在Go中，函数可以是一个闭包，闭包是一个函数值，它引用函数体之外的变量。这个函数可以对该引用的变量进行访问和赋值，换句话说，这个函数被绑定在这个变量上。例如下例中，函数<code>adder</code>返回一个闭包，每个返回的闭包都被绑定到其各自的sum变量上。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="comment">//返回值为函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">adder</span><span class="params">()</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span>)</span><span class="title">int</span></span>&#123;</span><br><span class="line">  	sum := <span class="number">0</span></span><br><span class="line">  	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(x <span class="keyword">int</span>)</span></span>&#123;</span><br><span class="line">      	sum += x</span><br><span class="line">      	<span class="keyword">return</span> sum</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  	pos, neg := adder(), adder()</span><br><span class="line">  	<span class="keyword">for</span> i := <span class="number">0</span> ; i &lt; <span class="number">10</span> ; i++ &#123;</span><br><span class="line">      	fmt.Println(</span><br><span class="line">        	pos(i),</span><br><span class="line">         	neg(<span class="number">-2</span>*i),</span><br><span class="line">        )</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line"><span class="number">0</span> <span class="number">0</span></span><br><span class="line"><span class="number">1</span> <span class="number">-2</span></span><br><span class="line"><span class="number">3</span> <span class="number">-6</span></span><br><span class="line"><span class="number">6</span> <span class="number">-12</span></span><br><span class="line"><span class="number">10</span> <span class="number">-20</span></span><br><span class="line"><span class="number">15</span> <span class="number">-30</span></span><br><span class="line"><span class="number">21</span> <span class="number">-42</span></span><br><span class="line"><span class="number">28</span> <span class="number">-56</span></span><br><span class="line"><span class="number">36</span> <span class="number">-72</span></span><br><span class="line"><span class="number">45</span> <span class="number">-90</span></span><br></pre></td></tr></table></figure>
<p>练习：斐波那契闭包</p>
<blockquote>
<p>实现一个 <code>fibonacci</code> 函数，返回一个函数（一个闭包）可以返回连续的斐波纳契数。</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="comment">// fibonacci 函数会返回一个返回 int 的函数。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fibonacci</span><span class="params">()</span> <span class="title">func</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	num1 := <span class="number">0</span> </span><br><span class="line"> 	num2 := <span class="number">1</span></span><br><span class="line">  	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">      	sum := num1 + num2</span><br><span class="line">      	num1 = num2</span><br><span class="line">      	num2 = sum</span><br><span class="line">      	<span class="keyword">return</span> sum</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	f := fibonacci()</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">		fmt.Println(f())</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">13</span></span><br><span class="line"><span class="number">21</span></span><br><span class="line"><span class="number">34</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="方法和接口"><a href="#方法和接口" class="headerlink" title="方法和接口"></a>方法和接口</h2><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><ol>
<li><p>Go中没有类的概念，但是仍然可以在结构体类型上定义方法。方法接收者位于<code>func</code>关键字和方法名之间的参数中。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">  	<span class="string">"math"</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">type</span> Vertex <span class="keyword">struct</span>&#123;</span><br><span class="line">  	X, Y <span class="keyword">float64</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *Vertex)</span> <span class="title">Abs</span><span class="params">()</span> <span class="title">float64</span></span>&#123;</span><br><span class="line">  	<span class="keyword">return</span> math.Sqrt(v.X * v.X + v.Y * v.Y)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  	v := &amp;Vertex&#123;<span class="number">3</span>, <span class="number">4</span>&#125;</span><br><span class="line">  	fmt.Println(v.Abs())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line"><span class="number">5</span></span><br></pre></td></tr></table></figure>
<p>此外，可以对包中的任意类型定义任何方法，而不仅仅是结构体类型。但是不能对来自其他包的的类型或者基础类型定义方法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">  	<span class="string">"math"</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">type</span> MyFloat <span class="keyword">float64</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f MyFloat)</span> <span class="title">Abs</span><span class="params">()</span> <span class="title">float64</span></span>&#123;</span><br><span class="line">  	<span class="keyword">if</span>　f &lt; <span class="number">0</span> &#123;</span><br><span class="line">      	<span class="keyword">return</span> <span class="keyword">float64</span>(-f)</span><br><span class="line">  	&#125;</span><br><span class="line">  	<span class="keyword">return</span> <span class="keyword">float64</span>(f)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  	f:= MyFloat(-math.Sqrt(<span class="number">2</span>))</span><br><span class="line">  	fmt.Println(f.Abs())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line"><span class="number">1.4142135623730951</span></span><br></pre></td></tr></table></figure>
<p>方法可以与命名类型或者命名类型的指针关联。以上的两个例子中，一个是在<code>*Vertex</code>指针类型上，一个是在<code>MyFloat</code>值类型上。有两个原因需要使用指针接收者：① 避免在每个方法调用中拷贝值(如果值类型是大的结构体的话更有效率)；② 方法可以修改接收者指向的值。在下面的例子中，如果在<code>Scale</code>方法中使用<code>Vertex</code>代替<code>* Vertex</code>作为接收者。当<code>v</code>是<code>Vertex</code>的时候<code>Scale</code>方法不会有任何作用，其看到的只是<code>Vertex</code>的副本，而无法修改原始值。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"math"</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">type</span> Vertex <span class="keyword">struct</span> &#123;</span><br><span class="line">	X, Y <span class="keyword">float64</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *Vertex)</span> <span class="title">Scale</span><span class="params">(f <span class="keyword">float64</span>)</span></span> &#123;</span><br><span class="line">	v.X = v.X * f</span><br><span class="line">	v.Y = v.Y * f</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *Vertex)</span> <span class="title">Abs</span><span class="params">()</span> <span class="title">float64</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> math.Sqrt(v.X*v.X + v.Y*v.Y)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	v := &amp;Vertex&#123;<span class="number">3</span>, <span class="number">4</span>&#125;</span><br><span class="line">	fmt.Printf(<span class="string">"Before scaling: %+v, Abs: %v\n"</span>, v, v.Abs())</span><br><span class="line">	v.Scale(<span class="number">5</span>)</span><br><span class="line">	fmt.Printf(<span class="string">"After scaling: %+v, Abs: %v\n"</span>, v, v.Abs())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">Before scaling: &amp;&#123;X:<span class="number">3</span> Y:<span class="number">4</span>&#125;, Abs: <span class="number">5</span></span><br><span class="line">After scaling: &amp;&#123;X:<span class="number">15</span> Y:<span class="number">20</span>&#125;, Abs: <span class="number">25</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h3><ol>
<li><p>接口类型是一组方法定义的组合，其类型的值可以存放实现这些方法的任何值。下面的示例中，接口<code>Abser</code>中声明了一个方法<code>Abs</code>，而后给出<code>Abs</code>的两种定义实现，一个是针对<code>*Vertex</code>指针类型，一个是针对<code>MyFloat</code>值类型。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"math"</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">type</span> Abser <span class="keyword">interface</span> &#123;</span><br><span class="line">	Abs() <span class="keyword">float64</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> MyFloat <span class="keyword">float64</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f MyFloat)</span> <span class="title">Abs</span><span class="params">()</span> <span class="title">float64</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> f &lt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">float64</span>(-f)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">float64</span>(f)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> Vertex <span class="keyword">struct</span> &#123;</span><br><span class="line">	X, Y <span class="keyword">float64</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *Vertex)</span> <span class="title">Abs</span><span class="params">()</span> <span class="title">float64</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> math.Sqrt(v.X*v.X + v.Y*v.Y)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> a Abser</span><br><span class="line">	f := MyFloat(-math.Sqrt2)</span><br><span class="line">	a = f	<span class="comment">// a MyFloat 实现了 Abser</span></span><br><span class="line">	fmt.Println(a.Abs())</span><br><span class="line">	v := Vertex&#123;<span class="number">3</span>, <span class="number">4</span>&#125;</span><br><span class="line">	a = &amp;v <span class="comment">// a *Vertex 实现了 Abser</span></span><br><span class="line">	fmt.Println(a.Abs())</span><br><span class="line">	<span class="comment">// 下面一行，v 是一个 Vertex（而不是 *Vertex）</span></span><br><span class="line">	<span class="comment">// 所以没有实现 Abser。</span></span><br><span class="line">	<span class="comment">//a = v</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line"><span class="number">1.4142135623730951</span></span><br><span class="line"><span class="number">5</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>类型通过实现那些方法实现接口，没有显示声明的必要；所以就没有关键字implements。隐式接口解耦了实现接口的包和定义接口的包：互补依赖。因此，也就无需在每一个实现上新增新的接口名称，这样同时也鼓励了明确的接口定义。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">  	<span class="string">"os"</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">type</span> Reader <span class="keyword">interface</span>&#123;</span><br><span class="line">  	Read(b []<span class="keyword">byte</span>)(n <span class="keyword">int</span>, err error)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> Writer <span class="keyword">interface</span>&#123;</span><br><span class="line">  	Write(b []<span class="keyword">byte</span>)(n <span class="keyword">int</span>, err error)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> ReaderWriter <span class="keyword">interface</span>&#123;</span><br><span class="line">  	Reader</span><br><span class="line">  	Writer</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">var</span> w Writer</span><br><span class="line">  w = os.Stdout <span class="comment">// os.Stdout 实现了 Writer</span></span><br><span class="line">  fmt.Fprintf(w, <span class="string">"hello, writer\n"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">hello, writer</span><br></pre></td></tr></table></figure>
</li>
<li><p>一个普遍存在的接口是<code>fmt</code>包中定义的<code>Stringer</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Stringer <span class="keyword">interface</span>&#123;</span><br><span class="line">  	String() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Stringer</code>是一个可以用字符串描述自己的类型。<code>fmt</code>包(还有许多其他包)使用这个来进行输出。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span>&#123;</span><br><span class="line">  	Name <span class="keyword">string</span></span><br><span class="line">  	Age <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p Person)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span>&#123;</span><br><span class="line">  	<span class="keyword">return</span> fmt.Sprintf(<span class="string">"%v (%v years"</span>, p.Name, p.Age)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  	a := Person&#123;<span class="string">"Xiaotong Wang"</span>, <span class="number">23</span>&#125;</span><br><span class="line">  	z := Person&#123;<span class="string">"Feng Zhu"</span>, <span class="number">24</span>&#125;</span><br><span class="line">  	fmt.Println(a, z)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">Xiaotong Wang (<span class="number">23</span> years) Feng Zhu (<span class="number">24</span> years)</span><br></pre></td></tr></table></figure>
<p>练习：Stringers</p>
<blockquote>
<p>让IPAddr类型实现fmt.Stringer以便用点分格式输出地址。</p>
<p>例如，IPAddr{1, 2, 3, 4}应当输出”1.2.3.4”。</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="keyword">type</span> IPAddr [<span class="number">4</span>]<span class="keyword">byte</span></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> Add a "String() string" method to IPAddr.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ip IPAddr)</span><span class="title">String</span><span class="params">()</span> <span class="title">string</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> fmt.Sprintf(<span class="string">"%v.%v.%v.%v"</span>,ip[<span class="number">0</span>],ip[<span class="number">1</span>],ip[<span class="number">2</span>],ip[<span class="number">3</span>])</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	addrs := <span class="keyword">map</span>[<span class="keyword">string</span>]IPAddr&#123;</span><br><span class="line">		<span class="string">"loopback"</span>:  &#123;<span class="number">127</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>&#125;,</span><br><span class="line">		<span class="string">"googleDNS"</span>: &#123;<span class="number">8</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">8</span>&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> n, a := <span class="keyword">range</span> addrs &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"%v: %v\n"</span>, n, a)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">loopback: <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">googleDNS: <span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="错误"><a href="#错误" class="headerlink" title="错误"></a>错误</h3><ol>
<li><p>在Go中程序使用 <code>error</code>值来表示错误状态。与 <code>fmt.Stringer</code> 类似， <code>error</code>类型也是一个内建接口：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> error <span class="keyword">interface</span>&#123;</span><br><span class="line">  	Error() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通常，函数会返回一个<code>error</code>值，调用它的代码应当判断这个错误是否等于<code>nil</code>，来进行错误处理。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">i, err := strconv.Atoi(<span class="string">"42"</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">    fmt.Printf(<span class="string">"couldn't convert number: %v\n"</span>, err)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">"Converted integer:"</span>, i)</span><br></pre></td></tr></table></figure>
<p><code>error</code> 为 nil 时表示成功；非 nil 的 <code>error</code> 表示错误。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">type</span> MyError <span class="keyword">struct</span>&#123;</span><br><span class="line">  	When time.Time</span><br><span class="line">  	What <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e MyError)</span> <span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span>&#123;</span><br><span class="line">  	<span class="keyword">return</span> fmt.Sprintf(<span class="string">"at %v, %s"</span>, e.When, e.What)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">run</span><span class="params">()</span> <span class="title">error</span></span>&#123;</span><br><span class="line">  	<span class="keyword">return</span> MyError&#123;</span><br><span class="line">      	time.Now(),</span><br><span class="line">      	<span class="string">"it didn't work"</span>.</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> err:= run;err != <span class="literal">nil</span>&#123;</span><br><span class="line">    	fmt.Println(err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">at <span class="number">2009</span><span class="number">-11</span><span class="number">-10</span> <span class="number">23</span>:<span class="number">00</span>:<span class="number">00</span> +<span class="number">0000</span> UTC, it didn<span class="string">'t work</span></span><br></pre></td></tr></table></figure>
<p>练习：错误</p>
<blockquote>
<p>从先前的练习中复制 <code>Sqrt</code> 函数，并修改使其返回 <code>error</code>值。</p>
<p>由于不支持复数，当 <code>Sqrt</code> 接收到一个负数时，应当返回一个非 nil 的错误值。</p>
<p>创建一个新类型</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">type</span> ErrNegativeSqrt <span class="keyword">float64</span></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<p>为其实现</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="function"><span class="keyword">func</span> <span class="params">(e ErrNegativeSqrt)</span> <span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span></span><br><span class="line"><span class="function">&gt;</span></span><br></pre></td></tr></table></figure>
<p>使其成为一个 error， 该方法就可以让 ErrNegativeSqrt(-2).Error() 返回 <code>&quot;cannot Sqrt negative number: -2&quot;</code>。<br><em>注意：</em> 在 Error 方法内调用 fmt.Sprint(e) 将会让程序陷入死循环。可以通过先转换 e 来避免这个问题：fmt.Sprint(float64(e))。请思考这是为什么呢？<br>修改 Sqrt 函数，使其接受一个负数时，返回 ErrNegativeSqrt 值。</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">type</span> ErrNegativeSqrt <span class="keyword">float64</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e ErrNegativeSqrt)</span><span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> fmt.Sprintf(<span class="string">"cannot Sqrt negtive number: %v"</span>,<span class="keyword">float64</span>(e))	</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sqrt</span><span class="params">(x <span class="keyword">float64</span>)</span> <span class="params">(<span class="keyword">float64</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> x &lt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, ErrNegativeSqrt(x)	</span><br><span class="line">	&#125;</span><br><span class="line">	z := <span class="keyword">float64</span>(<span class="number">1</span>)</span><br><span class="line">	<span class="keyword">for</span> i:= <span class="number">0</span> ; i&lt; <span class="number">10</span> ;i++ &#123;</span><br><span class="line">		z = z - (z*z-x)/(<span class="number">2</span>*z)	</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> z, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(Sqrt(<span class="number">2</span>))</span><br><span class="line">	fmt.Println(Sqrt(<span class="number">-2</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line"><span class="number">1.414213562373095</span> &lt;<span class="literal">nil</span>&gt;</span><br><span class="line"><span class="number">0</span> cannot Sqrt negtive number: <span class="number">-2</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="Readers"><a href="#Readers" class="headerlink" title="Readers"></a>Readers</h3><ol>
<li><p><code>io</code> 包指定了 <code>io.Reader</code> 接口，它表示从数据流结尾读取。Go标准库包含了这个接口的许多实现，包括文件、网络连接、压缩、加密等。 <code>io.Reader</code> 接口有一个 <code>Read</code>方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(T)</span> <span class="title">Read</span><span class="params">(b []<span class="keyword">byte</span>)</span><span class="params">(n <span class="keyword">int</span>, err error)</span></span></span><br></pre></td></tr></table></figure>
<p><code>Read</code> 用数据填充指定的字节slice，返回填充的字节数和错误信息。在遇到数据流结尾时，返回<code>io.EOF</code>错误。下面的例子中创建了一个<code>strings.Reader</code>，每次以8字节的速度读取输出。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"io"</span></span><br><span class="line">	<span class="string">"strings"</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  r := strings.NewReader(<span class="string">"Hello, Reader!"</span>)</span><br><span class="line">  b	:= <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">8</span>)</span><br><span class="line">  <span class="keyword">for</span>&#123;</span><br><span class="line">    	n, err := r.Read(b)</span><br><span class="line">    	fmt.Printf(<span class="string">"n = %v err = %v b = %v\n"</span>,n, err, b)</span><br><span class="line">    	fmt.Printf(<span class="string">"b[:n] = %q\n"</span>, b[:n])</span><br><span class="line">    	<span class="keyword">if</span> err == io.EOF&#123;</span><br><span class="line">          	<span class="keyword">break</span></span><br><span class="line">    	&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">n = <span class="number">8</span> err = &lt;<span class="literal">nil</span>&gt; b = [<span class="number">72</span> <span class="number">101</span> <span class="number">108</span> <span class="number">108</span> <span class="number">111</span> <span class="number">44</span> <span class="number">32</span> <span class="number">82</span>]</span><br><span class="line">b[:n] = <span class="string">"Hello, R"</span></span><br><span class="line">n = <span class="number">6</span> err = &lt;<span class="literal">nil</span>&gt; b = [<span class="number">101</span> <span class="number">97</span> <span class="number">100</span> <span class="number">101</span> <span class="number">114</span> <span class="number">33</span> <span class="number">32</span> <span class="number">82</span>]</span><br><span class="line">b[:n] = <span class="string">"eader!"</span></span><br><span class="line">n = <span class="number">0</span> err = EOF b = [<span class="number">101</span> <span class="number">97</span> <span class="number">100</span> <span class="number">101</span> <span class="number">114</span> <span class="number">33</span> <span class="number">32</span> <span class="number">82</span>]</span><br><span class="line">b[:n] = <span class="string">""</span></span><br></pre></td></tr></table></figure>
<p>练习：Reader</p>
<blockquote>
<p>实现一个Reader类型，它不断生成ASCII字符‘A’的流。</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"golang.org/x/tour/reader"</span></span><br><span class="line"><span class="keyword">type</span> MyReader <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> Add a Read([]byte) (int, error) method to MyReader.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r MyReader)</span><span class="title">Read</span><span class="params">(b []<span class="keyword">byte</span>)</span><span class="params">(n <span class="keyword">int</span>, err error)</span></span>&#123;</span><br><span class="line">	b[<span class="number">0</span>] = <span class="string">'A'</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	reader.Validate(MyReader&#123;&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">OK!</span><br></pre></td></tr></table></figure>
<p>练习：rot13Reader</p>
<blockquote>
<p>一个常见的模式是 <code>io.Reader</code>包裹另一个 <code>io.Reader</code>，然后通过某种形式修改数据流。例如 <code>gzip.NewReader</code>函数接受 <code>io.Reader</code>(压缩的数据流)，并且返回同样实现了 <code>io.Reader</code>的 <code>*gzip.Reader</code>（解压后的数据流）。</p>
<p>编写一个实现了 <code>io.Reader</code>的 <code>rot13Reader</code>，并从一个 <code>io.Reader</code>读取，利用rot13代换密码对数据流进行修改。</p>
<p>已经帮你构造了 <code>rot13Reader</code>类型。通过实现 <code>Read</code>方法使其匹配 <code>io.Reader</code>。</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"io"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">	<span class="string">"strings"</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">type</span> rot13Reader <span class="keyword">struct</span> &#123;</span><br><span class="line">	r io.Reader</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rot rot13Reader)</span> <span class="title">Read</span><span class="params">(b []<span class="keyword">byte</span>)</span><span class="params">(n <span class="keyword">int</span>, err error)</span></span>&#123;</span><br><span class="line">	rot.r.Read(b)</span><br><span class="line">	length := <span class="built_in">len</span>(b)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span> ; i&lt; length; i++ &#123;</span><br><span class="line">		<span class="keyword">switch</span> &#123;</span><br><span class="line">			<span class="keyword">case</span> b[i] &gt;= <span class="string">'a'</span> &amp;&amp; b[i] &lt; <span class="string">'n'</span>:	</span><br><span class="line">				<span class="keyword">fallthrough</span></span><br><span class="line">			<span class="keyword">case</span> b[i] &gt;= <span class="string">'A'</span> &amp;&amp; b[i] &lt; <span class="string">'N'</span>:</span><br><span class="line">				b[i] = b[i] + <span class="number">13</span></span><br><span class="line">			<span class="keyword">case</span> b[i] &gt;= <span class="string">'n'</span> &amp;&amp; b[i] &lt;= <span class="string">'z'</span>:</span><br><span class="line">				<span class="keyword">fallthrough</span></span><br><span class="line">			<span class="keyword">case</span> b[i] &gt;= <span class="string">'N'</span> &amp;&amp; b[i] &lt;= <span class="string">'Z'</span>:</span><br><span class="line">				b[i] = b[i] - <span class="number">13</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> length, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	s := strings.NewReader(<span class="string">"Lbh penpxrq gur pbqr!"</span>)</span><br><span class="line">	r := rot13Reader&#123;s&#125;</span><br><span class="line">	io.Copy(os.Stdout, &amp;r)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="Web服务器"><a href="#Web服务器" class="headerlink" title="Web服务器"></a>Web服务器</h3><ol>
<li><p>包 <code>http</code>通过任何实现了 <code>http.Handler</code> 的值来响应HTTP请求：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> http</span><br><span class="line"><span class="keyword">type</span> Handler <span class="keyword">interface</span>&#123;</span><br><span class="line">  	ServeHTTP(w ResponserWriter, r *Request)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在下面例子中，类型 <code>Hello</code> 实现了 <code>http.Handler</code> 。访问 <a href="http://localhost:4000/" target="_blank" rel="noopener">http://localhost:4000/</a> 会看到来自程序的问候。需要注意的是，这个例子无法在基于web的指南用户界面运行。为了编写web服务器，可能需要安装Go。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">  	<span class="string">"log"</span></span><br><span class="line">  	<span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">type</span> Hello <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h Hello)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponserWirter, r *http.Request)</span></span>&#123;</span><br><span class="line">  	fmt.Fprint(w, <span class="string">"Hello!"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  	<span class="keyword">var</span> h Hello</span><br><span class="line">  	err := http.ListenAndServe(<span class="string">"localhost:4000"</span>,h)	</span><br><span class="line">  	<span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">     	log.Fatal(err)</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>练习：HTTP处理</p>
<blockquote>
<p>实现下面的类型，并在其上定义ServeHTTP方法。在web服务器中注册它们来处理指定的路径。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">type</span> String <span class="keyword">string</span></span><br><span class="line">&gt; <span class="keyword">type</span> Struct <span class="keyword">struct</span>&#123;</span><br><span class="line">&gt;   	Greeting <span class="keyword">string</span></span><br><span class="line">&gt;   	Punct <span class="keyword">string</span></span><br><span class="line">&gt;   	Who <span class="keyword">string</span></span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<p>例如，可以使用如下方式注册处理方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; http.Handle(<span class="string">"/string"</span>, String(<span class="string">"I'm a frayed knot."</span>))</span><br><span class="line">&gt; http.Handle(<span class="string">"/struct"</span>, &amp;Struct(<span class="string">"Hello"</span>,<span class="string">":"</span>,<span class="string">"Gophers!"</span>))</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<p>在启动你的http服务器后，你将能够访问：</p>
<p><a href="http://localhost:4000/string" target="_blank" rel="noopener">http://localhost:4000/string</a> 和 <a href="http://localhost:4000/struct" target="_blank" rel="noopener">http://localhost:4000/struct</a></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">  	<span class="string">"net/http"</span></span><br><span class="line">  	<span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">type</span> String <span class="keyword">string</span></span><br><span class="line"><span class="keyword">type</span> Struct <span class="keyword">struct</span>&#123;</span><br><span class="line">  	Greeting <span class="keyword">string</span></span><br><span class="line">  	Punct <span class="keyword">string</span></span><br><span class="line">  	Who <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s String)</span><span class="title">ServeHTTP</span><span class="params">(w http.ResponserWirter, r *http.Request)</span></span>&#123;</span><br><span class="line">  	fmt.Fprint(w, s) </span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s Sttruct)</span><span class="title">ServeHTTP</span><span class="params">(w http.ResponserWirter, r *http.Request)</span></span>&#123;</span><br><span class="line">  	fmt.Fprint(w, s) </span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  	http.Handle(<span class="string">"/string"</span>, String(<span class="string">"I'm a frayed knot."</span>))</span><br><span class="line">	http.Handle(<span class="string">"/struct"</span>, &amp;Struct(<span class="string">"Hello"</span>,<span class="string">":"</span>,<span class="string">"Gophers!"</span>))</span><br><span class="line">  	log.Fatal(http.ListenAndServe(<span class="string">"localhost:4000"</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="图片"><a href="#图片" class="headerlink" title="图片"></a>图片</h3><ol>
<li><p><code>Package image</code>定义了 <code>Image</code> 接口：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> image</span><br><span class="line"><span class="keyword">type</span> Image <span class="keyword">interface</span>&#123;</span><br><span class="line"> 	ColorModel() color.model</span><br><span class="line"> 	Bounds() Rectangle</span><br><span class="line"> 	At(x, y <span class="keyword">int</span>) color.Color</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意， <code>Bounds</code> 方法的 <code>Rectangle</code> 返回值其实是一个 <code>image.Rectangle</code>，其定义在 <code>image</code>包中。 <code>color.Color</code>和 <code>color.Model</code>也是接口，但是通常因为直接使用预定义的实现<code>image.RGBA</code>和<code>image.RGBAModel</code>而被忽视了。这些接口和类型由<code>image/color</code>包定义。 </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  	<span class="string">"fmt"</span></span><br><span class="line">  	<span class="string">"image"</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  	m := image.NewRGBA(image.Rect(<span class="number">0</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">100</span>))</span><br><span class="line">  	fmt.Println(m.Bounds())</span><br><span class="line">  	fmt.Println(m.At(<span class="number">0</span>, <span class="number">0</span>).RGBA())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">(<span class="number">0</span>,<span class="number">0</span>)-(<span class="number">100</span>,<span class="number">100</span>)</span><br><span class="line"><span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>练习：</p>
<blockquote>
<p>还记得之前编写的图片生成器吗？现在来另外编写一个，不过这次将会返回 <code>image.Image</code> 来代替 slice 的数据。</p>
<p>自定义的 <code>Image</code> 类型，要实现必要的方法，并且调用<code>pic.ShowImage</code>。</p>
<p><code>Bounds</code> 应当返回一个 <code>image.Rectangle</code>，例如 <code>image.Rect(0, 0, w, h)</code>。</p>
<p><code>ColorModel</code> 应当返回 <code>color.RGBAModel</code>。</p>
<p><code>At</code> 应当返回一个颜色；在这个例子里，在最后一个图片生成器的值 <code>v</code> 匹配 <code>color.RGBA{v, v, 255, 255}</code>。</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"> 	<span class="string">"golang.org/x/tour/pic"</span></span><br><span class="line">  	<span class="string">"image/color"</span></span><br><span class="line">  	<span class="string">"image"</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">type</span> Image <span class="keyword">struct</span>&#123;</span><br><span class="line">  	Width <span class="keyword">int</span></span><br><span class="line">  	Height <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(i Image)</span> <span class="title">Bounds</span><span class="params">()</span> <span class="title">image</span>.<span class="title">Rectangle</span></span>&#123;</span><br><span class="line">  	<span class="keyword">return</span> image.Rect(<span class="number">0</span>, <span class="number">0</span>, i.Width, i.Height)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(i Image)</span> <span class="title">ColorModel</span><span class="params">()</span> <span class="title">color</span>.<span class="title">Model</span></span>&#123;</span><br><span class="line"> 	<span class="keyword">return</span> color.RGBAModel</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(i Image)</span> <span class="title">At</span><span class="params">(x, y <span class="keyword">int</span>)</span> <span class="title">color</span>.<span class="title">Color</span></span>&#123;</span><br><span class="line">  	<span class="keyword">return</span> color.RGBA&#123;<span class="keyword">uint8</span>(x), <span class="keyword">uint8</span>(y), <span class="number">255</span>, <span class="number">255</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"> 	m := Image&#123;Width:<span class="number">100</span>, Height:<span class="number">100</span>&#125;</span><br><span class="line">	pic.ShowImage(m)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="并发"><a href="#并发" class="headerlink" title="并发"></a>并发</h2><h3 id="goroutine"><a href="#goroutine" class="headerlink" title="goroutine"></a>goroutine</h3><ol>
<li><p><code>goroutine</code>是由Go运行时环境管理的轻量级线程。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> f(x, y ,z)</span><br></pre></td></tr></table></figure>
<p>开启一个新的goroutine执行</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f(x, y ,z)</span><br></pre></td></tr></table></figure>
<p>f, x, y 和 z是当前goroutine中定义的，但是在新的goroutine中运行f。goroutine在相同的地址空间中运行，因此访问共享内存必须进行同步。<a href="https://go-zh.org/pkg/sync/" target="_blank" rel="noopener"><code>sync</code></a> 提供了这种可能，不过在Go中并不经常用到，因为有其他的办法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">  	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">say</span><span class="params">(s <span class="keyword">string</span>)</span></span>&#123;</span><br><span class="line">  	<span class="keyword">for</span> i := <span class="number">0</span> ; i &lt; <span class="number">5</span> ; i++ &#123;</span><br><span class="line">      	time.Sleep(<span class="number">100</span> * time.Millisecond)</span><br><span class="line">      	fmt.Println(s)</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">go</span> say(<span class="string">"world"</span>)</span><br><span class="line">  say(<span class="string">"hello"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">world</span><br><span class="line">hello</span><br><span class="line">hello</span><br><span class="line">world</span><br><span class="line">world</span><br><span class="line">hello</span><br><span class="line">hello</span><br><span class="line">world</span><br><span class="line">world</span><br><span class="line">hello</span><br></pre></td></tr></table></figure>
</li>
<li><p>channel是有类型的管道，可以用channel操作符 <code>&lt;-</code> 对其发送或者接收值。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ch &lt;- v <span class="comment">//　将v送人channel ch</span></span><br><span class="line">v := &lt;-ch <span class="comment">//从ch接收，并赋值给v</span></span><br></pre></td></tr></table></figure>
<p>箭头就是数据流入的方法</p>
<p>和map和slice一样，channel在使用前必须创建：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br></pre></td></tr></table></figure>
<p>默认情况下，在另一端准备好之前，发送和接收都会阻塞。这使得goroutine可以在没有明确锁或竞态变量的情况下进行同步。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sum</span><span class="params">(a []<span class="keyword">int</span>, c <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span>&#123;</span><br><span class="line">  	sum := <span class="number">0</span></span><br><span class="line">  	<span class="keyword">for</span> _, v := <span class="keyword">range</span> a &#123;</span><br><span class="line">      	sum += v</span><br><span class="line">  	&#125;</span><br><span class="line">  	c &lt;- sum <span class="comment">//将和送入c</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  	a := []<span class="keyword">int</span>&#123;<span class="number">7</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">-9</span>, <span class="number">4</span>, <span class="number">0</span>&#125;</span><br><span class="line">  	c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">  	<span class="keyword">go</span> sum(a[:<span class="built_in">len</span>(a)/<span class="number">2</span>],c)</span><br><span class="line"> 	<span class="keyword">go</span> sum(a[<span class="built_in">len</span>(a)/<span class="number">2</span>:],c)</span><br><span class="line">  	x, y := &lt;-c, &lt;-c <span class="comment">//从c中获取</span></span><br><span class="line"> 	fmt.Println(x, y ,x+y)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line"><span class="number">-5</span> <span class="number">17</span> <span class="number">12</span></span><br></pre></td></tr></table></figure>
<p>channel是可以带缓冲的。为<code>make</code>提供第二个参数作为缓冲长度来初始化一个缓冲channel：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">100</span>)</span><br></pre></td></tr></table></figure>
<p> 向带缓冲的channel发送数据的时候，只有在缓冲区满的时候才会阻塞。而当缓冲区为空的时候接收操作会阻塞。而当缓冲区为空时，接收操作会阻塞。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">2</span>)</span><br><span class="line">  	ch &lt;- <span class="number">1</span></span><br><span class="line">  	ch &lt;- <span class="number">2</span></span><br><span class="line">  	fmt.Println(&lt;-ch)</span><br><span class="line">  	fmt.Println(&lt;-ch)</span><br><span class="line">&#125;</span><br><span class="line">output:</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>若修改上面这个例子，使得缓冲区被填满，则会报错：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">2</span>)</span><br><span class="line">  	ch &lt;- <span class="number">1</span></span><br><span class="line">  	ch &lt;- <span class="number">2</span></span><br><span class="line"> 	ch &lt;- <span class="number">1</span></span><br><span class="line">  	fmt.Println(&lt;-ch)</span><br><span class="line">  	fmt.Println(&lt;-ch)</span><br><span class="line">&#125;</span><br><span class="line">output:</span><br><span class="line">fatal error: all goroutines are asleep - deadlock!</span><br><span class="line"></span><br><span class="line">goroutine <span class="number">1</span> [<span class="keyword">chan</span> send]:</span><br><span class="line">main.main()</span><br><span class="line">	/tmp/sandbox402344606/main.<span class="keyword">go</span>:<span class="number">9</span> +<span class="number">0x100</span></span><br></pre></td></tr></table></figure>
<p>发送者可以 <code>close</code> 一个channel来表示再没有值会被发送了。接收者可以通过赋值语句的第二个参数来测试channel是否被关闭：当没有值可以接收并且channel已经被关闭，那么经过</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v, ok := &lt;-ch</span><br></pre></td></tr></table></figure>
<p>之后， <code>ok</code> 会被设置为false。</p>
<p>循环 <code>for i := range c</code>会不断从channel接收值，<strong>直到它被关闭</strong>。需要注意的是，<strong>只有发送者才能关闭channel</strong>，而不是接收者。 向一个已经关闭的channel发送数据会引起panic。channel与文件不同，通常情况下不需要关闭它们，只有在需要告诉接收者没有更过的数据的时候才有必要进行关闭，例如中断一个range。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fibonacci</span><span class="params">(n <span class="keyword">int</span>, c <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span>&#123;</span><br><span class="line">  	x, y := <span class="number">0</span>, <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span> ; i &lt; n ; i++ &#123;</span><br><span class="line">		c -&lt; x</span><br><span class="line">      	x, y = y, x+y</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="built_in">close</span>(c)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  	c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line">  	<span class="keyword">go</span> fibonacci(<span class="built_in">cap</span>(c),c)</span><br><span class="line">  	<span class="keyword">for</span> i := <span class="keyword">range</span> c&#123;</span><br><span class="line">      	fmt.Println(i)</span><br><span class="line">  	&#125;</span><br><span class="line">  	c &lt;- <span class="number">2</span> <span class="comment">// panic</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">13</span></span><br><span class="line"><span class="number">21</span></span><br><span class="line"><span class="number">34</span></span><br><span class="line"><span class="built_in">panic</span>: send on closed channel</span><br><span class="line"></span><br><span class="line">goroutine <span class="number">1</span> [running]</span><br><span class="line">main.main()</span><br><span class="line">	/tmp/sandbox910931553/main.<span class="keyword">go</span>:<span class="number">22</span> +<span class="number">0x160</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>select</code>语句使得一个goroutine在多个通讯操作上等待。 <code>select</code>会阻塞，直到条件分支中的某个可以继续执行，这时会执行那个条件分支。当多个都准备好的时候，会随机选择一个。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fibonacci</span><span class="params">(c, quit <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span>&#123;</span><br><span class="line">     x, y := <span class="number">0</span>, <span class="number">1</span></span><br><span class="line">     <span class="keyword">for</span>&#123;</span><br><span class="line">         <span class="keyword">select</span>&#123;</span><br><span class="line">            <span class="keyword">case</span> c &lt;- x:</span><br><span class="line">              x, y = y, x+y</span><br><span class="line">            <span class="keyword">case</span> &lt;- quit:</span><br><span class="line">              fmt.Println(<span class="string">"quit"</span>)</span><br><span class="line">              <span class="keyword">return</span></span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">     c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">     quit := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">     <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span> i := <span class="number">0</span> ; i&lt; <span class="number">10</span>; i++&#123;</span><br><span class="line">         fmt.Println(&lt;-c)</span><br><span class="line">        &#125;</span><br><span class="line">         quit &lt;- <span class="number">0</span> </span><br><span class="line">     &#125;()</span><br><span class="line">     fibonacci(c, quit)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">13</span></span><br><span class="line"><span class="number">21</span></span><br><span class="line"><span class="number">34</span></span><br><span class="line">quit</span><br></pre></td></tr></table></figure>
<p>当<code>select</code> 中的其他条件分支都没有准备好的时候，<code>default</code>分支会被执行。为了非阻塞的发送或者接收，可使用<code>default</code>分支：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span>&#123;</span><br><span class="line"> <span class="keyword">case</span> i := &lt;-c:</span><br><span class="line">         <span class="comment">//使用i</span></span><br><span class="line">     <span class="keyword">default</span>:</span><br><span class="line">         <span class="comment">//从c读取会阻塞</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"> <span class="string">"fmt"</span></span><br><span class="line">     <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  tick := time.Tick(<span class="number">100</span> * time.Millisecond)</span><br><span class="line">  boom := time.After(<span class="number">500</span> * time.Millisecond)</span><br><span class="line">  <span class="keyword">for</span>&#123;</span><br><span class="line">     <span class="keyword">select</span>&#123;</span><br><span class="line">          <span class="keyword">case</span> &lt;- tick:</span><br><span class="line">             fmt.Println(<span class="string">"tick."</span>)</span><br><span class="line">          <span class="keyword">case</span> &lt;- boom:</span><br><span class="line">             fmt.Println(<span class="string">"boom!"</span>)</span><br><span class="line">             <span class="keyword">return</span></span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">             fmt.Println(<span class="string">"    ."</span>)</span><br><span class="line">             time.Sleep(<span class="number">50</span> * time.Millisecond)</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">tick.</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">tick.</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">tick.</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">tick.</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">tick.</span><br></pre></td></tr></table></figure>
<p>练习：等价二叉树</p>
<blockquote>
<p>可以用多种不同的二叉树的叶子节点存储相同的数列值。用于检查两个二叉树村出了相同的序列的函数在多数语言中都是相当复杂的。这里将使用Go的并发和channel来编写一个简单的解法。这个例子使用了 <code>tree</code> 包，定义了类型：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">type</span> Tree <span class="keyword">struct</span>&#123;</span><br><span class="line">&gt;   	Left *Tree</span><br><span class="line">&gt;   	Value <span class="keyword">int</span></span><br><span class="line">&gt;   	Right *Tree</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<ol>
<li><p>实现Walk函数。</p>
</li>
<li><p>测试Walk函数。函数 <code>tree.New(k)</code> 构造了一个随机结构的二叉树，保存了值 <code>k</code>，<code>2k</code>，<code>3k</code>，…，<code>10k</code>。创建一个新的channel <code>ch</code> 并对其进行步进：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;    <span class="keyword">go</span> Walk(tree.New(<span class="number">1</span>), ch)</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>   然后从channel 中读取并打印10个值。应当是1，2，3 ，…，10。</p>
<ol>
<li><p>用 <code>Walk</code> 实现 <code>Same</code> 函数来检测是否 <code>t1</code> 和 <code>t2</code> 存储了相同的值。</p>
</li>
<li><p>测试 <code>Same</code> 函数。</p>
<p><code>Same(tree.New(1), tree.New(1))</code>应当返回true，而<code>Same(tree.New(1), tree.New(２))</code>应当返回false。</p>
</li>
</ol>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"golang.org/x/tour/tree"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Walk</span><span class="params">(t *tree.Tree, ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> t == <span class="literal">nil</span>&#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    Walk(t.Left, ch)</span><br><span class="line">    ch &lt;- t.Value</span><br><span class="line">    Walk(t.Right, ch)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Same</span><span class="params">(t1, t2 *tree.Tree)</span><span class="title">bool</span></span>&#123;</span><br><span class="line">    ch1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    ch2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Walk(t1, ch1)</span><br><span class="line">        ch1 &lt;- <span class="number">0</span></span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Walk(t2, ch2)</span><br><span class="line">        ch2 &lt;- <span class="number">0</span></span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">for</span>&#123;</span><br><span class="line">        t1 := &lt;- ch1</span><br><span class="line">        t2 := &lt;- ch2</span><br><span class="line">        <span class="keyword">if</span> t1 == <span class="number">0</span> &amp;&amp; t2 == <span class="number">0</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> t1 == t2 &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Walk(tree.New(<span class="number">1</span>), ch)</span><br><span class="line">        ch &lt;- <span class="number">0</span></span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">for</span>&#123;</span><br><span class="line">        t := &lt;- ch</span><br><span class="line">        <span class="keyword">if</span> t == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Println(t)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(Same(tree.New(<span class="number">2</span>), tree.New(<span class="number">2</span>)))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="sync-Mutex"><a href="#sync-Mutex" class="headerlink" title="sync.Mutex"></a>sync.Mutex</h3><ol>
<li><p>我们已经看到 <code>channel</code> 用在各个goroutine间进行通信是非常合适的了。但是如果我们不需要进行通信呢？比如说，如果我们只想保证在每个时刻，只有一个goroutine能访问一个共享的变量从而避免冲突？这里涉及的概念叫做互斥。通常使用互斥锁<code>mutex</code>来提供这个限制。Go标准库中提供了  <code>sync.Mutex</code>类型及其两个方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Lock</span><br><span class="line">Unlock</span><br></pre></td></tr></table></figure>
<p>我们可以通过在代码前调用 <code>Lock</code> 方法，在代码后调用 <code>Unlock</code>方法来保证一段代码的互斥执行。我们也可以用</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span>(</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">  	<span class="string">"sync"</span></span><br><span class="line">  	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"><span class="comment">// SafeCounter的并发使用是安全的</span></span><br><span class="line"><span class="keyword">type</span> SafeCounter <span class="keyword">struct</span>&#123;</span><br><span class="line">  	v <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span></span><br><span class="line">  	mux sync.Mutex</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Inc增加给定key的计数器的值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(c *SafeCounter)</span> <span class="title">Inc</span><span class="params">(key <span class="keyword">string</span>)</span></span>&#123;</span><br><span class="line">  	c.mux.Lock()</span><br><span class="line">  	c.v[key]++</span><br><span class="line">  	c.mux.Unlock()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Value返回给定key的计数器的当前值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *SafeCounter)</span> <span class="title">Value</span><span class="params">(key <span class="keyword">string</span>)</span><span class="title">int</span></span>&#123;</span><br><span class="line">  	c.mux.Lock()</span><br><span class="line">  	<span class="keyword">defer</span> c.mux.Unlock()</span><br><span class="line">  	<span class="keyword">return</span> c.v[key]</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"> 	c := SafeCounter&#123;v: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]iint)&#125;</span><br><span class="line">  	<span class="keyword">for</span> i := <span class="number">0</span> ; i &lt; <span class="number">1000</span> ; i++&#123;</span><br><span class="line">      	<span class="keyword">go</span> c.Inc(<span class="string">"somekey"</span>)</span><br><span class="line">  	&#125;</span><br><span class="line">  	time.Sleep(time.Second)</span><br><span class="line">  	fmt.Println(c.Value(<span class="string">"somekey"</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line"><span class="number">1000</span></span><br></pre></td></tr></table></figure>
<p>练习：Web爬虫</p>
<blockquote>
<p>在这个练习中，将会用Go的并发特性来并行执行web爬虫。修改 <code>Crawl</code>函数来并行抓取URLs，并且保证不重复。</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">  	<span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">var</span> crawled = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span>)</span><br><span class="line"><span class="keyword">var</span> crawledMutex sync.Mutex</span><br><span class="line"><span class="keyword">type</span> fakeFetcher <span class="keyword">map</span>[<span class="keyword">string</span>]*fakeResult</span><br><span class="line"><span class="keyword">type</span> fakeResult <span class="keyword">struct</span> &#123;</span><br><span class="line">     body <span class="keyword">string</span></span><br><span class="line">     urls     []<span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> Fetcher <span class="keyword">interface</span>&#123;</span><br><span class="line">  	<span class="comment">//Fetch返回URL的body内容，并且将在这个页面上找到的URL放到一个slice中</span></span><br><span class="line">  	Fetch(url <span class="keyword">string</span>)(body <span class="keyword">string</span>, urls []<span class="keyword">string</span>, err error)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *fakeFetcher)</span> <span class="title">Fetch</span><span class="params">(url <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, []<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">     <span class="keyword">if</span> res, ok := (*f)[url]; ok &#123;</span><br><span class="line">          <span class="keyword">return</span> res.body, res.urls, <span class="literal">nil</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="string">""</span>, <span class="literal">nil</span>, fmt.Errorf(<span class="string">"not found: %s"</span>, url)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Crawl使用fetcher从某个url开始递归地爬取页面，直到达到最大深度</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Crawl</span><span class="params">(url <span class="keyword">string</span>, depth <span class="keyword">int</span>, fetcher Fetcher, out <span class="keyword">chan</span> <span class="keyword">string</span>, end <span class="keyword">chan</span> <span class="keyword">bool</span>)</span></span>&#123;</span><br><span class="line">  	<span class="comment">//并行抓取URL</span></span><br><span class="line">  	<span class="comment">//不重复抓取页面</span></span><br><span class="line">  	<span class="keyword">if</span> depth &lt;= <span class="number">0</span>&#123;</span><br><span class="line">  		<span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"> 	<span class="keyword">if</span> _, ok := crawled[url];ok&#123;</span><br><span class="line">      	end &lt;- <span class="literal">true</span></span><br><span class="line">      	<span class="keyword">return</span></span><br><span class="line"> 	&#125;</span><br><span class="line">  	crawledMutex.Lock()</span><br><span class="line">  	crawled[url] = <span class="literal">true</span></span><br><span class="line">  	crawledMutex.Unlock()</span><br><span class="line">  	body, urls, err := fetcher.Fetch(url)</span><br><span class="line">  	<span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">      	fmt.Println(err)</span><br><span class="line">      	<span class="keyword">return</span></span><br><span class="line">  	&#125;</span><br><span class="line">  	out &lt;- fmt.Sprintf(<span class="string">"found: %s %q\n"</span>, url, body)</span><br><span class="line">  	subEnd := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span><br><span class="line">  	<span class="keyword">for</span> _, u := <span class="keyword">range</span> urls&#123;</span><br><span class="line">      	<span class="keyword">go</span> Crawl(u, depth<span class="number">-1</span>, fetcher, out, subEnd)</span><br><span class="line">  	&#125;</span><br><span class="line">  	<span class="keyword">for</span> i := <span class="number">0</span> ; i &lt; <span class="built_in">len</span>(urls); i++&#123;</span><br><span class="line">      	&lt;- subEnd</span><br><span class="line">  	&#125;</span><br><span class="line">	end &lt;- <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    out := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">    end := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span><br><span class="line">  	<span class="keyword">go</span> Crawl(<span class="string">"http://golang.org/"</span>,<span class="number">4</span>,fetcher,out, end)</span><br><span class="line">  	<span class="keyword">for</span>&#123;</span><br><span class="line">     	<span class="keyword">select</span>&#123;</span><br><span class="line">          	<span class="keyword">case</span> t := &lt;-out:</span><br><span class="line">          		fmt.Print(t)</span><br><span class="line">          	<span class="keyword">case</span> &lt;- end:</span><br><span class="line">          		<span class="keyword">return</span></span><br><span class="line">     	&#125;</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>

			
			
		<br>
		
		
		
<div class="copyright">
  <p><span>Title:</span><a href="/2017/03/12/go/">Go初探</a></p>
  <p><span>Author:</span><a href="/" title="visit Tankcat 's personal blog">Tankcat</a></p>
  <p><span>Release Date:</span>2017-03-12  21:31</p>
  <p><span>Update Date:</span>2017-05-05  19:27</p>
  <p>
    <span>Original Link:</span><a href="/2017/03/12/go/" title="Go初探">http://tankcat2.com/2017/03/12/go/</a>
    <span class="btn" data-clipboard-text="Master Copy: http://tankcat2.com/2017/03/12/go/　　Author: Tankcat" title="copy the article link">
        <i class="fa fa-clipboard"></i>
    </span>
  </p>
 <p><span>License Agreement:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="Mainland China (CC BY-NC-SA 3.0 CN)">"Signature-Non Commercial-Share Alike 3.0"</a>.
 <br>
 <br>
 <span>Please retain the original link and author if reprinting.
 </span>
 </p>
  <script src="/js/clipboard.min.js"></script>
  <script> var clipboard = new Clipboard('.btn'); </script>
</div>
<style type="text/css">
  .copyright p .btn {
    margin-left: 1em;
  }
  .copyright:hover p .btn::after {
    content: "Copy"
  }
  .copyright p .btn:hover {
      color: gray;
      cursor: pointer;
    };
</style>

<br>
<br>
		<style type="text/css">
		  .center {
			  text-align: center;
		  }
		  .hidden {
			  display: none;
		  }
		.donate_bar a.btn_donate{
		  display: inline-block;
		  width: 82px;
		  height: 82px;
		  background: url("http://7xsl28.com1.z0.glb.clouddn.com/btn_reward.gif") no-repeat;
		  _background: url("http://7xsl28.com1.z0.glb.clouddn.com/btn_reward.gif") no-repeat;
		  -webkit-transition: background 0s;
		  -moz-transition: background 0s;
		  -o-transition: background 0s;
		  -ms-transition: background 0s;
		  transition: background 0s;
		}

		.donate_bar a.btn_donate:hover{ background-position: 0px -82px;}
		.donate_bar .donate_txt {
		  display: block;
		  color: #9d9d9d;
		  font: 14px/2 "Microsoft Yahei";
		}
		.bold{ font-weight: bold; }
	  </style>
	  
	  
	  
	  <div id="donate_module">
		<div id="donate_board" class="donate_bar center">
		打赏 | Buy me a coffee<br/><br/>
		<a id="btn_donate" class="btn_donate" target="_self" href="javascript:;" title="Donate 打赏" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}"></a>
		  
		
		</div>
		
		<div id="QR" style="display: none;">
			<br>
		  <br>
		
		<a href="http://7xwggp.com1.z0.glb.clouddn.com/webwxgetmsgimg.jpg" title="用微信扫一扫哦~" class="fancybox" rel="article0">
		  <img src="http://7xwggp.com1.z0.glb.clouddn.com/webwxgetmsgimg.jpg" title="微信打赏 Colin" height="250px" width="250px"/>
		</a>
		<br>
		<center>
		<span class="donate_txt">
		  If you enjoy the blog, please feel free to donate~Thx for your support.
		</span>
	</center>
	  </div>
	  <br>
	   
	  </div>
		
				
			
        </div>
		
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://tankcat2.com/2017/03/12/go/" data-id="cjagcldx9000wkkkx24qi93pl" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=' + encodedUrl + '" class="fa fa-qq article-share-qzone" target="_blank" title="Qzone"></a>',
                            '<a href="http://service.weibo.com/share/share.php?url=' + encodedUrl + '" class="fa fa-weibo article-share-weibo" target="_blank" title="Weibo"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://tankcat2.com/2017/03/12/go/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://tankcat2.com/2017/03/12/go/">Comments</a>
    

        </footer>
		
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2017/03/14/Lecture1_MapReduce/" id="article-nav-newer" class="article-nav-link-wrap">
            <strong class="article-nav-caption">Newer</strong>
            <div class="article-nav-title">
                
                    MIT 6.824 Lecture 1 MapReduce
                
            </div>
        </a>
    
    
        <a href="/2017/02/27/evil/" id="article-nav-older" class="article-nav-link-wrap">
            <strong class="article-nav-caption">Older</strong>
            <div class="article-nav-title">再见我的暴力女王</div>
        </a>
    
</nav>


    
</article>




	
    
    <section id="comments" style="border-radius:1.5px; box-shadow: 10px 10px 5px #ccc;">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>


</section>
			
			
			
        </div>

			<div style="height:10px;pistion:absolute;bottom:0"></div>
<footer id="footer" >
    <div class="outer">
		<div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        <div id="footer-info" class="inner">
            &copy; 2017 <i class="fa fa-heart blink-slow"></i> Tankcat<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
        </div>
		
    </div>
</footer>
			
    
    <script>
    var disqus_config = function () {
        
            this.page.url = 'http://tankcat2.com/2017/03/12/go/';
        
        this.page.identifier = 'go';
    };
    (function() { 
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'tankcat2' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>



    
        <script src="/vendor/lightgallery/js/lightgallery.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-pager.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-hash.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-share.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-video.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

	
    </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>

</html>