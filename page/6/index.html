<!DOCTYPE html>
<html lang=en>
<head>
	<!-- hexo-inject:begin --><!-- hexo-inject:end --><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css">   
    <meta charset="utf-8">
    
    <title>Tankcat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    

    

    
        <link rel="shortcut icon" href="/css/images/favicon.ico" />
    
	
    <link rel="stylesheet" href="/vendor/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/vendor/open-sans/styles.css">
    <link rel="stylesheet" href="/vendor/source-code-pro/styles.css">
	<link rel="stylesheet" href="/css/comment.css">
    <link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/tagclouds.css">
	<link rel="stylesheet" href="/css/font-awesome.css">
    <script src="/vendor/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/vendor/lightgallery/css/lightgallery.min.css">
    
    
    
    
    


	<script src="//cdn.bootcss.com/jquery/2.1.0/jquery.min.js" type="text/javascript"></script>
	<script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->


</head>


<body>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="containerr">
        
    <header id="header" style="padding-top:15px">
    <div id="header-main" class="header-inner">
			
			 <div class="outer">

				<a href="/" id="logo">
					<i class="logo"></i>
	
				</a>
				<nav id="main-nav">
					
						<a class="main-nav-link" href="/index.html">Home</a>
					
						<a class="main-nav-link" href="/archives">Archive</a>
					
						<a class="main-nav-link" href="/categories">Category</a>
					
						<a class="main-nav-link" href="/tags">Tag</a>
					
						<a class="main-nav-link" href="/about">About</a>
					
						<a class="main-nav-link" href="/favorite">Photos</a>
					
				</nav>
			</div> 
	</div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/index.html">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archive</a></td>
                
                    <td><a class="main-nav-link" href="/categories">Category</a></td>
                
                    <td><a class="main-nav-link" href="/tags">Tag</a></td>
                
                    <td><a class="main-nav-link" href="/about">About</a></td>
                
                    <td><a class="main-nav-link" href="/favorite">Photos</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>




			
        <div class="outer">
			<aside id="profile">
					<div class="profile-inner">
					</div>
			</aside>
			
					<section id="main">
    <article id="post-sodagreen" class="article article-type-post" itemscope itemprop="blogPost">
    
	<div class="article-inner" style="border-radius:1.5px; box-shadow: 10px 10px 5px #ccc;">
        
            
	
		<a href="/2016/10/17/sodagreen/" itemprop="url">
            <img src="http://7xwggp.com1.z0.glb.clouddn.com/sodagreen.jpg" class="article-banner" />
        </a>
	



        
        
            <header class="article-header">
				
					<center>
    
        <h1 itemprop="name">
            <a class="article-title" href="/2016/10/17/sodagreen/">My Favorite Band</a>
        </h1>
    

					 
						<div class="article-meta">
							
    <div class="article-date">    
        <a href="/2016/10/17/sodagreen/">
            <time datetime="2016-10-17T12:02:31.000Z" itemprop="datePublished">2016-10-17</time>
        </a>
    </div>

							<!--
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Jottings/">Jottings</a>
		&nbsp;&nbsp;
		
			<span class="article-tag">
				<i class="fa fa-tag"></i>
				<a class="tag-link" href="/tags/苏打绿/">苏打绿</a>
			</span>
		
    </div>
-->
							<!--
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/苏打绿/">苏打绿</a>
    </div>
-->
						</div>
					
					
					
					</center>
				
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            <p><p>Sodagreen is a Taiwanese indie band formed in 2001. Its member has been unchanged since 2003: lead vocals Wu Tsing-Fong, guitarist Liu Jia-Kai, guitarist Ho Jing-Yang, keyboardist Kung Yu-Chi, bass guitarist Hsieh Shin-Yi and drummer Shih Jun-Wei. The band was originally named by Shih and Wu affixed his favorite color, green, to the name. </p>
<p>Pure, artistic, indie, free, soft and simple. All of these are my impression of Sodagreen. The band is well known for its lead vocalist and songwriter Wu Tsing-Fong, who is excellent for his poetic lyrics, unique performing style and wide vocal range. As a typical Virgo, he is a paranoia that is disproportionate to an idol. He never does what an idol should do. He is unwilling to please the fans and doesn’t like to participate in the announcement program. To be a qualified artist is very hard; to be an artist who can satisfy all the fans is harder. I still remember the live show in Spring Wave Music And Art Festival this year. Sodagreen was arranged to the final appearance and didn’t finish all the songs in that the organizer advanced the end of the show and turned off the microphone domineeringly. Wu reluctantly left in the dark, but insisted on singing the rest of the songs through Weibo.</p>
<p>One of my favorite albums is “Summer/Fever”. Whenever I feel sad, I will listen to this album, which has inspiring power. It was released on September 11, 2009 and is their fifth full-length studio album. It is the second of the band’s Vivaldi Project, a planned series of four albums representing the four seasons respectively. The recording of this album took place in London and the songs were mostly written by the lead vocalist Wu. The album contains Britpop elements and lyrical references to the supernatural, Faust, Madame Butterfly, Don Quixote and the Greek god Dionysus. Among the songs of this album, I like “The Sound That Remains” best. In the lyrics, it draws an analogy between the sound of cicadas and the flood of public opinion, which narrows our horizon. I think the metaphor of the song is what Sodagreen has being teaching us: Don’t always mind about what other people think of you and just be free to pursue the self-value realization.</p>
<p>The Sodagreen’s last round of road show “After Summer” before their temporarily overturn has launched. I wish I could grab a ticket for the live show in Shanghai!<br></p>
            <p class="article-more-link">
               <a href="/2016/10/17/sodagreen/#more">Read More</a>
				
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/苏打绿/">苏打绿</a>
    </div>

            </p>
        
        </div>
		
    </div>
    
</article>





    <article id="post-sssj" class="article article-type-post" itemscope itemprop="blogPost">
    
	<div class="article-inner" style="border-radius:1.5px; box-shadow: 10px 10px 5px #ccc;">
        
            
	
		<a href="/2016/08/23/sssj/" itemprop="url">
            <img src="http://7xwggp.com1.z0.glb.clouddn.com/005yXe3qgw1f4tv3vh6eyj30zk0grjtj.jpg" class="article-banner" />
        </a>
	



        
        
            <header class="article-header">
				
					<center>
    
        <h1 itemprop="name">
            <a class="article-title" href="/2016/08/23/sssj/">Streaming Similarity Self-Join</a>
        </h1>
    

					 
						<div class="article-meta">
							
    <div class="article-date">    
        <a href="/2016/08/23/sssj/">
            <time datetime="2016-08-23T05:45:31.000Z" itemprop="datePublished">2016-08-23</time>
        </a>
    </div>

							
						</div>
					
					
					
					</center>
				
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            <p><p><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=default"></script></p>
<h1 id="Abstract-摘要"><a href="#Abstract-摘要" class="headerlink" title="Abstract 摘要"></a>Abstract 摘要</h1><p>在数据流环境下，系统处理的数据是源源不断流进的数据项。本文研究的问题是，数据流相似性的连接处理(SSSJ)，即在数据流中找出所有的两两数据项对，它们的相似度超过一个给定的阈值。解决这个问题最简单的构想是能拥有无限大的内存空间，但目前来讲，这是不能获得的。因此为了解决这个问题，本文提出了一个概念，<code>时间依赖的相似性</code>，两个数据项到达的时间间隔越大，它们的相似度越低。<br>在此概念的基础上，本文设计两种算法框架：① 微批次处理(MiniBatch,简称MB)，使用目前已有的基于索引的过滤技术；② 流处理(Streaming,简称STR),在索引的基础上增加时间过滤，并在算法中集成一种新的基于时间的边界处理。除此之外，本文基于L2AP的索引设计一种新的适用于数据流环境的索引算法，即L2。</p>
<h1 id="Introduction-介绍"><a href="#Introduction-介绍" class="headerlink" title="Introduction 介绍"></a>Introduction 介绍</h1><p>在数据库和数据挖掘领域，相关性自连接处理被广泛研究，其应用场景较为广泛，包括剽窃检测、查询优化、协同过滤、重复网页的检测与去除等。若使用暴力解法，其复杂度是\(O(n^2)\)。在现实应用中，数据项常以高维稀疏向量的形式呈现，那么相似度的计算即为余弦相似值的计算。为了方便处理，可以将向量归一化，则进一步将问题转换为两个向量的点积。目前解决相似度自连接的算法主要依赖于基于倒排索引的删减技术以及一些数值界限。<br>计算相似度自连接，不仅适用于静态的数据集，在数据流领域也同样适用。这里举例两个现实应用，在数据流环境下进行相似度自连接处理。</p>
<ul>
<li>趋势监测。社交平台，譬如Twitter，趋势监测算法识别频率陡增的主题标签。更细粒度的趋势监测算法也会识别微博集合。这些集合中的数据项出现的频率增加，并且同时出现某些相同的标签。对于该趋势监测算法，在数据流环境下找出相似的微博十分重要。</li>
<li>近似重复项过滤。同样，在社交平台，譬如Twitter，当某个事件发生时，用户们可能会接收到与该事件相关的近似重复的多条微博。这些微博通常连续地出现。因此，将这些近似重复的微博进行过滤或者分组有利于提高用户体验。</li>
</ul>
<p>但问题是，关于数据流环境下的相似度自连接处理的研究并不多。这是由于缺乏无限内存：不能将先到来数据项随意删除，因为该数据项可能与未来到的数据项相似。<br>本文引入一个时间因子来解决内存问题。我们设定，只有在到达的时间间隔在指定范围内，两个数据项才有可能相似。我们定义时间依赖的相似性：基于内容的点积与时间因子的乘积，该时间因子会随着时间间隔的增加呈现指数级减小。由于时间因子的存在，当某些数据项的到达时间超出一定范围，我们可以将这些数据项删除。下图表达了这个idea。<br>    <div align="center"><img src="http://7xwggp.com1.z0.glb.clouddn.com/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20160823155752.png" alt="时序图"> </div></p>
<p>如上图所示，标记有时间戳的文档以数据流的形式源源不断到达。时间轴上方的文档包含相似的内容，标记为红色。在所有两两相似的文档对中，我们只关心到达时间相近的文档对。因此，图中所有的4-选-2的文档对里，只有两对文档被选中(用蓝色箭头标记)。<br>与已有的相似性自连接处理算法类似，本文的算法也依赖于索引技术。已有的算法使用不同类型的<code>索引过滤</code>，以减少通过索引返回的潜在配对项数量。按照这种语义，我们定义<code>时间过滤</code>来，与时间依赖的相似性进行关联，以便将旧的索引项从索引列表中删除。<br>本文提出了两种算法框架来解决数据流的相似性自连接处理，均依赖于时间过滤。MB框架使用现成的索引技术，在运行过程中以流水线的方式创建两个索引，随着时间的推移丢弃旧索引。STR框架对现有的索引技术进行调整，将时间过滤的因素内嵌到其中。此外，本文结合已有的索引技术AP和L2AP，设计了一种可处理流式数据的索引算法L2,它存在以下四点优势：</p>
<ol>
<li>有效减少潜在相似数据项的配对数量；</li>
<li>不需要收集数据流的统计信息；</li>
<li>使用轻量级的索引维持；</li>
<li>当数据项变“旧”时，可以迅速丢弃。</li>
</ol></p>
            <p class="article-more-link">
               <a href="/2016/08/23/sssj/#more">Read More</a>
				
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Stream/">Stream</a>
    </div>

            </p>
        
        </div>
		
    </div>
    
</article>





    <article id="post-lein" class="article article-type-post" itemscope itemprop="blogPost">
    
	<div class="article-inner" style="border-radius:1.5px; box-shadow: 10px 10px 5px #ccc;">
        
        
            <header class="article-header">
				
					<center>
    
        <h1 itemprop="name">
            <a class="article-title" href="/2016/07/18/lein/">Leiningen安装</a>
        </h1>
    

					 
						<div class="article-meta">
							
    <div class="article-date">    
        <a href="/2016/07/18/lein/">
            <time datetime="2016-07-18T05:09:31.000Z" itemprop="datePublished">2016-07-18</time>
        </a>
    </div>

							
						</div>
					
					
					
					</center>
				
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            <p><p>Leiningen作为Clojure的项目创建和管理工具，在Ubuntu系统下的安装过程如下：</p>
<blockquote>
<ol>
<li>Make sure you have a Java JDK version 6 or later.</li>
<li>Download the lein script from the stable branch of this project.</li>
<li>Place it on your $PATH. (~/bin is a good choice if it is on your path.)</li>
<li>Set it to be executable. (chmod 755 ~/bin/lein)</li>
<li>Run it.</li>
</ol>
</blockquote>
<p>这段安装教程是摘录自<a href="https://github.com/technomancy/leiningen/blob/stable/README.md" target="_blank" rel="noopener">Leiningen</a>，翻译如下：</p>
<ol>
<li>安装Java JDK，确保其版本是6.0以及6.0之后的；</li>
<li>下载<a href="https://raw.githubusercontent.com/technomancy/leiningen/stable/bin/lein" target="_blank" rel="noopener">lein脚本</a></li>
<li>在/bin目录下新建一个名为<code>lein</code>的文件，将上述脚本拷贝进去并保存；</li>
<li><p>运行命令以下命令使得<code>lein</code>为可执行文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ chmod 755 ~/bin/lein</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行<code>lein</code>，下载leiningen-xxx-standalone.jar(xxx为版本)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ lein</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>由于网络连接的问题，下载过程中可能出现错误，比如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">It&apos;s also possible that you&apos;re behind a firewall and haven&apos;t set HTTP_PROXY and HTTPS_PROXY.</span><br></pre></td></tr></table></figure></p>
<p>解决方案：删除掉~/.lein目录后，执行<code>export HTTP_CLIENT=&quot;wget --no-check-certificate -O&quot;</code>，然后重新执行<code>lein</code>即可。</p></p>
            <p class="article-more-link">
               <a href="/2016/07/18/lein/#more">Read More</a>
				
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Leiningen/">Leiningen</a>
    </div>

            </p>
        
        </div>
		
    </div>
    
</article>





    <article id="post-storm component" class="article article-type-post" itemscope itemprop="blogPost">
    
	<div class="article-inner" style="border-radius:1.5px; box-shadow: 10px 10px 5px #ccc;">
        
            
	
		<a href="/2016/07/16/storm component/" itemprop="url">
            <img src="http://7xwggp.com1.z0.glb.clouddn.com/storm-flow.png" class="article-banner" />
        </a>
	



        
        
            <header class="article-header">
				
					<center>
    
        <h1 itemprop="name">
            <a class="article-title" href="/2016/07/16/storm component/">Storm组件和拓扑结构</a>
        </h1>
    

					 
						<div class="article-meta">
							
    <div class="article-date">    
        <a href="/2016/07/16/storm component/">
            <time datetime="2016-07-16T02:06:31.000Z" itemprop="datePublished">2016-07-16</time>
        </a>
    </div>

							
						</div>
					
					
					
					</center>
				
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            <p><h1 id="Storm简介"><a href="#Storm简介" class="headerlink" title="Storm简介"></a>Storm简介</h1><p>　Storm是Twitter开源的一个类似Hadoop的实时数据处理框架，它原来是由BackType开发，后被Twitter收购，将Storm作为Twitter的实时数据分析系统。</p>
<h1 id="Storm总体结构"><a href="#Storm总体结构" class="headerlink" title="Storm总体结构"></a>Storm总体结构</h1><p>  Storm的术语比较多，本文涉及的有Spout，Bolt，Stream，Tuple，Stream Grouping，Topology。下面简单介绍一下。</p>
<ul>
<li>Tuple：包含了一个或者多个键值对的列表。默认情况下，元组tuple中的域可以是整型(integer)等基本类型对象。也可以通过定义可序列化(<strong>实现Serializable接口</strong>)的对象来实现自定义的元组类型。</li>
<li>Stream：Storm中最核心的概念，在分布式环境下并行创建、处理的元祖Tuple序列。在声明数据流的时候要给定一个有效的id，若不显示指定，则系统默认会给数据流定义一个名为”default”的id。</li>
<li>Spout：消息生产者，是数据流的数据来源，充当一个采集器的角色，连接到外部的数据源，并将数据转化为一个个tuple。</li>
<li>Bolt：消息处理者，封装了数据处理逻辑，将一个或者多个数据流作为输入，对数据实施运算后，选择性地输出一个或者多个数据流。几种典型的功能有数据过滤、连接、聚合和数据库读写等。</li>
<li>Stream Grouping：定义了消息分发策略，即定义了一个数据流中的tuple如何分发给topology中的不同bolt的任务实例。</li>
<li>Topology：用于封装一个实时计算应用程序的逻辑，类似于Hadoop中的Job。由Stream Grouping连接起来的Spout和Bolt的有向无环图，处理的是源源不断的消息流。</li>
</ul>
<h1 id="Storm编程基础"><a href="#Storm编程基础" class="headerlink" title="Storm编程基础"></a>Storm编程基础</h1><p>  Storm的源码共分为三层，分为如下：</p>
<ol>
<li>Storm最上层的所有接口均是用Java定义的。</li>
<li>上层绝大多数接口的逻辑是用Clojure实现的。</li>
<li>最底层的数据结构是用Thrift定义的。Thrift是Apache下面的跨语言框架，它可以基于Thrift定义文件产生不同语言的代码，有关详细内容可以参考<a href="http://thrift.apache.org/" target="_blank" rel="noopener">thrift</a>。</li>
</ol>
<p>本文主要就上层Java接口介绍Storm的拓扑和组件结构。</p>
<h2 id="拓扑Topology"><a href="#拓扑Topology" class="headerlink" title="拓扑Topology"></a>拓扑Topology</h2><p>  首先，从最外层开始，举一个如何创建topology的例子。代码中的对象下面会一一介绍。<span id="builder"><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">TopologyBuilder builder = <span class="keyword">new</span> TopologyBuilder();</span><br><span class="line">builder.setSpout(<span class="string">"spout1"</span>, <span class="keyword">new</span> Spout1(), <span class="number">1</span>);</span><br><span class="line">builder.setSpout(<span class="string">"spout2"</span>, <span class="keyword">new</span> Spout2(), <span class="number">5</span>);</span><br><span class="line">builder.setBolt(<span class="string">"bolt"</span>, <span class="keyword">new</span> Bolt1(), <span class="number">3</span>)</span><br><span class="line">        .directGrouping(<span class="string">"spout1"</span>, <span class="string">"stream1"</span>)</span><br><span class="line">        .shuffleGrouping(<span class="string">"spout2"</span>);</span><br><span class="line">Config conf = <span class="keyword">new</span> Config();</span><br><span class="line">conf.setDebug(<span class="keyword">true</span>);</span><br><span class="line">StormSubmitter.submitTopology(<span class="string">"my-topology"</span>, conf, builder.createTopology());</span><br></pre></td></tr></table></figure></span></p>
<p></p>
<h3 id="TopologyBuilder"><a href="#TopologyBuilder" class="headerlink" title="TopologyBuilder"></a>TopologyBuilder</h3><p>第一行代码定义了一个TopologyBuilder对象。TopologyBuilder是一个工具类，用于构造topology。Topology最底层实际上是Thrift的一个数据结构，分为一下2个部分：</p>
<ol>
<li><p>StormTopology<br>定义了Topology的组成，包括Spout和Bolt，每个Spout或者Bolt都有全局唯一的id。目前为止，StateSpoutSpec还没有在设计代码中用到。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct StormTopology&#123;</span><br><span class="line">    1: required map&lt;string, SpoutSpec&gt; spouts;</span><br><span class="line">    2: required map&lt;string, Bolt&gt; bolts;</span><br><span class="line">    3: required map&lt;string, StateSpoutSpec&gt; state_spouts;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>TopologySummary<br>定义了用户提交的Topology的基本情况，例如该topology分布在几个工作进程上，使用了多少个线程，有多少个任务实例。这些数据主要供Nimbus使用，以返回UI请求的数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">struct TopologySummary&#123;</span><br><span class="line">    1: required string id;</span><br><span class="line">    2: required string name;</span><br><span class="line">    3: required i32 num_tasks;</span><br><span class="line">    4: required i32 num_executors;</span><br><span class="line">    5: required i32 num_workers;</span><br><span class="line">    6: required i32 uptime_secs;</span><br><span class="line">    7: required string status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>由于Topology在Thrift中过于描述化的特性不便于直接使用，所以TopologyBuilder进行了上层的封装，提供了更加方便的构建方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TopologyBuilder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, IRichBolt&gt; _bolts = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, IRichSpout&gt; _spouts = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, ComponentCommon&gt; _commons = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, StateSpoutSpec&gt; _stateSpouts = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    ... </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> StormTopology <span class="title">createTopology</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         Map&lt;String, Bolt&gt; boltSpecs = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">         Map&lt;String, SpoutSpec&gt; spoutSpecs = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">         maybeAddCheckpointSpout();</span><br><span class="line">         <span class="keyword">for</span>(String boltId: _bolts.keySet()) &#123;</span><br><span class="line">             IRichBolt bolt = _bolts.get(boltId);</span><br><span class="line">             bolt = maybeAddCheckpointTupleForwarder(bolt);</span><br><span class="line">             ComponentCommon common = getComponentCommon(boltId, bolt);</span><br><span class="line">             boltSpecs.put(boltId, <span class="keyword">new</span> Bolt(ComponentObject.serialized_java(Utils.javaSerialize(bolt)), common));   </span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">for</span>(String spoutId: _spouts.keySet()) &#123;</span><br><span class="line">             IRichSpout spout = _spouts.get(spoutId);</span><br><span class="line">             ComponentCommon common = getComponentCommon(spoutId, spout);</span><br><span class="line">             spoutSpecs.put(spoutId, <span class="keyword">new</span> SpoutSpec(ComponentObject.serialized_java(Utils.javaSerialize(spout)), common));</span><br><span class="line">         &#125;</span><br><span class="line">    </span><br><span class="line">         StormTopology stormTopology = <span class="keyword">new</span> StormTopology(spoutSpecs, boltSpecs,<span class="keyword">new</span> HashMap&lt;String, StateSpoutSpec&gt;());</span><br><span class="line">         stormTopology.set_worker_hooks(_workerHooks);</span><br><span class="line">         <span class="keyword">return</span> stormTopology;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> BoltDeclarer <span class="title">setBolt</span><span class="params">(String id, IRichBolt bolt, Number parallelism_hint)</span></span>&#123;</span><br><span class="line">         validateUnusedId(id);</span><br><span class="line">         initCommon(id, bolt, parallelism_hint);</span><br><span class="line">         _bolts.put(id, bolt);</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">new</span> BoltGetter(id);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> BoltDeclarer <span class="title">setBolt</span><span class="params">(String id, IRichBolt bolt)</span></span>&#123;</span><br><span class="line">         <span class="keyword">return</span> setBolt(id, bolt, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="function"><span class="keyword">public</span> BoltDeclarer <span class="title">setBolt</span><span class="params">(String id, IBasicBolt bolt)</span></span>&#123;</span><br><span class="line">         <span class="keyword">return</span> setBolt(id, bolt, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> BoltDeclarer <span class="title">setBolt</span><span class="params">(String id, IBasicBolt bolt, Number parallelism_hint)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> setBolt(id, <span class="keyword">new</span> BasicBoltExecutor(bolt), parallelism_hint);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> SpoutDeclarer <span class="title">setSpout</span><span class="params">(String id, IRichSpout spout, Number parallelism_hint)</span> </span>&#123;</span><br><span class="line">         validateUnusedId(id);</span><br><span class="line">         initCommon(id, spout, parallelism_hint);</span><br><span class="line">         _spouts.put(id, spout);</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">new</span> SpoutGetter(id);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> SpoutDeclarer <span class="title">setSpout</span><span class="params">(String id, IRichSpout spout)</span></span>&#123;</span><br><span class="line">         <span class="keyword">return</span> setSpout(id, spout, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">validateUnusedId</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">if</span>(_bolts.containsKey(id)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Bolt has already been declared for id "</span> + id);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span>(_spouts.containsKey(id)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Spout has already been declared for id "</span> + id);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span>(_stateSpouts.containsKey(id)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"State spout has already been declared for id "</span> + id);</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">     <span class="function"><span class="keyword">private</span> ComponentCommon <span class="title">getComponentCommon</span><span class="params">(String id, IComponent component)</span> </span>&#123;</span><br><span class="line">          ComponentCommon ret = <span class="keyword">new</span> ComponentCommon(_commons.get(id));</span><br><span class="line">          OutputFieldsGetter getter = <span class="keyword">new</span> OutputFieldsGetter();</span><br><span class="line">          component.declareOutputFields(getter);</span><br><span class="line">          ret.set_streams(getter.getFieldsDeclaration());</span><br><span class="line">          <span class="keyword">return</span> ret;</span><br><span class="line">     &#125;</span><br><span class="line">    </span><br><span class="line">     <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initCommon</span><span class="params">(String id, IComponent component, Number parallelism)</span> <span class="keyword">throws</span> IllegalArgumentException </span>&#123;</span><br><span class="line">          ComponentCommon common = <span class="keyword">new</span> ComponentCommon();</span><br><span class="line">          common.set_inputs(<span class="keyword">new</span> HashMap&lt;GlobalStreamId, Grouping&gt;());</span><br><span class="line">          <span class="keyword">if</span>(parallelism!=<span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="keyword">int</span> dop = parallelism.intValue();</span><br><span class="line">              <span class="keyword">if</span>(dop &lt; <span class="number">1</span>) &#123;</span><br><span class="line">                 <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Parallelism must be positive."</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              common.set_parallelism_hint(dop);</span><br><span class="line">          &#125;</span><br><span class="line">          Map conf = component.getComponentConfiguration();</span><br><span class="line">          <span class="keyword">if</span>(conf!=<span class="keyword">null</span>) common.set_json_conf(JSONValue.toJSONString(conf));</span><br><span class="line">          _commons.put(id, common);</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     ...</span><br></pre></td></tr></table></figure></p>
<ol>
<li><p>成员变量<code>_bolts</code>包含了所有的Bolt对象，<code>_spouts</code>包含了所有的spout对象，它们的类型分别是IRichBolt和IRichSpout类型，关于组件的接口下文会慢慢介绍。</p>
<ol>
<li><p>spout的thrift底层结构为SpoutSpec，包含了两个成员，一个是实现消息生产者具体逻辑的spout_object对象，另一个是用来描述其输入输出的common对象，具体定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">struct SpoutSpec&#123;</span><br><span class="line">    1: required ComponentObject spout_object;</span><br><span class="line">    2: required ComponentCommon common;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>bolt的thrift底层结构为Bolt，结构与SpoutSpec是一致的，这里不再阐述。</p>
</li>
</ol>
</li>
<li><p><code>_commons</code>包含了所有的Bolt和Spout对象，它在Thrift中的数据结构是ComponentCommon:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">struct ComponentCommon&#123;</span><br><span class="line">    1: required map&lt;GlobalStreamId, Grouping&gt; inputs;</span><br><span class="line">    2: required map&lt;string, StreamInfo&gt; streams;</span><br><span class="line">    3: optimal i32 parallelism_hint;</span><br><span class="line">    4: optimal string json_conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><p>ComponentCommon是用来表示Topology的基础组件对象,<code>inputs</code>表示该组件将从哪些GlobalStreamId以何种方式接收数据，其中GlobalStreamId是某个组件上定义的一条流，数据结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">struct GlobalStreamId&#123;</span><br><span class="line">    1: required string componentId;</span><br><span class="line">    2: required string streamId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>GlobalStreamId有两个域，componentId表示该流属于哪一个组件，streamId是流的标识。不同组件之间可以使用相同的streamId。分组方式Grouping决定了组件所发送的消息将以何种方式发送到接收端,Grouping被定义为union类型，即表示节点之间只能采取一种分组方式，其结构定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">union Grouping&#123;</span><br><span class="line">    1: list&lt;string&gt; fields //若为空，则采取global grouping的分组方式;</span><br><span class="line">    2: NullStruct shuffle; //随机分组</span><br><span class="line">    3: NullStruct all; //全分组，即广播</span><br><span class="line">    4: NullStruct none; //无分组，全部发送到同一个任务实例上</span><br><span class="line">    5: NullStruct direct; //直接分组，直接发送到指定的任务实例上</span><br><span class="line">    6: JavaObject custom_object;</span><br><span class="line">    7: binary custom_serialized;</span><br><span class="line">    8: NullStruct local_or_shuffle;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ComponentCommon中的<code>streams</code>指定了该组件需要输出的流，它给定了streamId以及StreamInfo。StreamInfo中定义了输出流的字段名列表以及该流的消息分组是否是直接分组方式，其结构定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">struct StreamInfo&#123;</span><br><span class="line">    1: required list&lt;string&gt; output_fields;</span><br><span class="line">    2: required bool direct;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ComponentCommon中的<code>parallelism_hint</code>表示组件的并行度，即有多少个线程，这些线程可分布在不同的进程空间或者机器中，默认值是１。</p>
</li>
<li>ComponentCommon中的<code>json_conf</code>保存了与该组件相关的一些设置。</li>
</ol>
</li>
<li><p>第29~46行定义了<code>setBolt()</code>方法以及其重载。该方法主要功能是定义topology中的bolt对象，并指定其并行度。该方法在运行的过程中首先会通过方法<code>validateUnusedId()</code>检测输入的组件ID是否是唯一的，其次调用<code>initCommon()</code>方法为该组件构建一个ComponentCommon对象，并且只初始化其并行度和配置信息，配置信息被序列化成JSON的形式。<code>setBolt()</code>最后会返回一个<code>BoltGetter</code>对象，将利用其为bolt对象添加输入流信息。关于这个对象后文再具体介绍。</p>
</li>
<li>第50~59行定义了<code>setSpout()</code>方法以及其重载。该方法类似于<code>setBolt()</code>方法，也会产生ComponentCommon对象。</li>
<li>第63~73行定义了<code>validateUnusedId()</code>方法，用于检测输入的组件Id是否是唯一的，若不是则抛出异常。</li>
<li>第75~81行定义了<code>getComponentCommon()</code>方法，该方法是在<code>createTopology()</code>创建拓扑的时候被调用的，设置了组件的输出流信息。</li>
<li>第83~96行定义了<code>initCommon()</code>方法，主要是对ComponentCommon对象进行初始化，设置并行度和配置信息。</li>
<li>最后一个也是最为重要的，第8~27行定义了<code>createTopology()</code>方法，根据输入的Bolt和Spout对象创建Topology对象。从第16行和第21行可以看出，在创建拓扑的过程中，Bolt和Spout均为对象序列化后得到的字节数组。</li>
</ol></p>
            <p class="article-more-link">
               <a href="/2016/07/16/storm component/#more">Read More</a>
				
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Storm/">Storm</a>
    </div>

            </p>
        
        </div>
		
    </div>
    
</article>





    <nav id="page-nav">
        <a class="extend prev" rel="prev" href="/page/5/">&laquo; Prev</a><a class="page-number" href="/home.html">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span>
    </nav>
</section>
			
			
			
        </div>

			<div style="height:10px;pistion:absolute;bottom:0"></div>
<footer id="footer" >
    <div class="outer">
		<div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        <div id="footer-info" class="inner">
            &copy; 2017 <i class="fa fa-heart blink-slow"></i> Tankcat<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
        </div>
		
    </div>
</footer>
			
    
<div id="container"></div>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>

<script>

var gitment = new Gitment({
  id: '',
  owner: 'tankcat',
  repo: 'tankcat.github.io',
  oauth: {
    client_id: '60fb85b01453b027d1f5',
    client_secret: '4d0e75031ae53e76418d288b34897a8718481fd2',
  },
})
gitment.render('comments')
</script>



    
        <script src="/vendor/lightgallery/js/lightgallery.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-pager.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-hash.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-share.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-video.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

	
    </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>

</html>